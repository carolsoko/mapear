<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MAPEAR — Pensamento Computacional</title>
  <link rel="icon" type="image/png" href="./MAPEARFavicon.png">
  <style>
:root {
  --bg: #0f172a;
  --panel: #111827;
  --text: #e5e7eb;
  --muted: #9ca3af;
  --primary: #22c55e;
  --accent: #60a5fa;
  --danger: #ef4444;
  --warning: #f59e0b;
  --ok: #10b981;
  --card: #0b1220;
}

* { box-sizing: border-box; }
html, body { height: 100%; }
body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
  background: radial-gradient(1200px 800px at 10% 10%, #0b1220, #0a0f1f 40%, #070b14 70%, #050911 100%);
  color: var(--text);
}

.app-header {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: flex-start;
  gap: 12px;
  padding: 16px 20px;
  background: linear-gradient(180deg, rgba(17,24,39,0.9), rgba(17,24,39,0.6));
  position: sticky;
  top: 0;
  backdrop-filter: blur(10px);
  z-index: 10;
}

.brand { display: flex; align-items: center; gap: 10px; }
.brand-text { display: flex; flex-direction: column; }
.brand-icon { width: 32px; height: 32px; border-radius: 8px; }
.brand-title { font-weight: 800; letter-spacing: 0.5px; color: var(--primary); }
.brand-subtitle { font-size: 12px; color: var(--muted); }

.main-nav { display: flex; flex-wrap: wrap; gap: 10px; }
.main-nav a {
  text-decoration: none;
  color: var(--text);
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid transparent;
}
.main-nav a:hover { background: rgba(96,165,250,0.1); border-color: rgba(96,165,250,0.3); }
.main-nav a.active { background: rgba(34,197,94,0.12); border-color: rgba(34,197,94,0.35); }

.app-container {
  max-width: 1000px;
  margin: 24px auto;
  padding: 0 16px 80px;
}

.card {
  background: linear-gradient(180deg, rgba(16,24,39,0.8), rgba(16,24,39,0.6));
  border: 1px solid rgba(148,163,184,0.15);
  border-radius: 14px;
  padding: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
}

.grid { display: grid; gap: 16px; }
.grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
@media (max-width: 800px) { .grid.cols-2 { grid-template-columns: 1fr; } }

h1, h2, h3 { margin: 0 0 10px; }
 h1 { font-size: 28px; }
 h2 { font-size: 22px; color: var(--accent); }
 h3 { font-size: 18px; color: var(--primary); }

p { color: var(--text); line-height: 1.6; }
.muted { color: var(--muted); }

.button {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  background: rgba(34,197,94,0.15);
  color: var(--text);
  border: 1px solid rgba(34,197,94,0.4);
  border-radius: 10px;
  cursor: pointer;
}
.button:hover { background: rgba(34,197,94,0.25); }
.button.secondary { background: rgba(96,165,250,0.12); border-color: rgba(96,165,250,0.4); }
.button.danger { background: rgba(239,68,68,0.12); border-color: rgba(239,68,68,0.4); }
.button.active { outline: 2px solid rgba(96,165,250,0.7); background: rgba(96,165,250,0.18); border-color: rgba(96,165,250,0.5); }

.input, textarea, select {
  width: 100%;
  padding: 10px 12px;
  background: var(--card);
  color: var(--text);
  border: 1px solid rgba(148,163,184,0.25);
  border-radius: 10px;
}
label { display: block; font-size: 13px; color: var(--muted); margin: 6px 0; }

.kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; background: #0a1220; padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(148,163,184,0.25); }

.tip {
  display: flex;
  gap: 10px;
  align-items: flex-start;
  padding: 10px 12px;
  background: rgba(96,165,250,0.08);
  border: 1px dashed rgba(96,165,250,0.5);
  border-radius: 10px;
}
.tip .badge { font-size: 11px; color: var(--accent); }
.tip .mentor { font-weight: 700; color: var(--accent); }

.list { list-style: none; padding: 0; margin: 0; }
.list li { padding: 10px 12px; border-bottom: 1px dashed rgba(148,163,184,0.15); }

.app-footer { position: fixed; bottom: 0; left: 0; right: 0; padding: 10px 16px; background: linear-gradient(180deg, rgba(17,24,39,0.0), rgba(17,24,39,0.8)); border-top: 1px solid rgba(148,163,184,0.15); text-align: center; color: var(--muted); }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <img class="brand-icon" alt="MAPEAR" src="./MAPEARFavicon.png">
      <div class="brand-text">
        <span class="brand-title">MAPEAR</span>
        <span class="brand-subtitle">Pensamento Computacional</span>
      </div>
    </div>
    <nav class="main-nav">
      <a href="#/" data-route>Início</a>
      <a href="#/padroes" data-route>Detective de Padrões</a>
      <a href="#/abstracao" data-route>Abstração</a>
      <a href="#/algoritmo" data-route>Algoritmos</a>
      <a href="#/generalizacao" data-route>Generalize+</a>
      <a href="#/robotica" data-route>Robótica</a>
      <a href="#/relatorios" data-route>Relatórios</a>
      <a href="#/ajustes" data-route>Ajustes</a>
    </nav>
  </header>

  <main id="app" class="app-container" aria-live="polite"></main>

  <footer class="app-footer">
    <small>Metodologia MAPEAR — Aprendizagem ativa, reflexiva e colaborativa.</small>
  </footer>

  <script>
  (function(){
    const STORAGE_KEY = 'mapear_state_v1';

    const defaultState = () => ({
      progress: {
        padroes: { completed: false, attempts: 0 },
        abstracao: { completed: false, attempts: 0 },
        algoritmo: { completed: false, attempts: 0 },
        generalizacao: { completed: false, attempts: 0 },
        robotica: { completed: false, attempts: 0 }
      },
      reflections: {
        padroes: '',
        abstracao: '',
        algoritmo: '',
        generalizacao: '',
        robotica: ''
      },
      scores: {
        padroes: null,
        abstracao: null,
        algoritmo: null,
        generalizacao: null,
        robotica: null
      },
      achievements: [],
      events: []
    });

    function getState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaultState();
        const parsed = JSON.parse(raw);
        const def = defaultState();
        return {
          ...def,
          ...parsed,
          progress: { ...def.progress, ...(parsed.progress || {}) },
          reflections: { ...def.reflections, ...(parsed.reflections || {}) },
          scores: { ...def.scores, ...(parsed.scores || {}) }
        };
      } catch {
        return defaultState();
      }
    }

    function saveState(next) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
    }

    function update(updater) {
      const current = getState();
      const next = updater({ ...current });
      saveState(next);
      return next;
    }

    function recordEvent(type, payload) {
      update(s => {
        s.events.push({ type, payload, ts: Date.now() });
        return s;
      });
    }

    function setReflection(key, text) {
      update(s => { s.reflections[key] = text; return s; });
    }

    function setScore(key, score) {
      update(s => { s.scores[key] = score; return s; });
    }

    function markCompleted(key) {
      update(s => { s.progress[key].completed = true; return s; });
    }

    function incrementAttempts(key) {
      update(s => { s.progress[key].attempts = (s.progress[key].attempts || 0) + 1; return s; });
    }

    function addAchievement(text) {
      update(s => { if (!s.achievements.includes(text)) s.achievements.push(text); return s; });
    }

    function exportState() {
      return JSON.stringify(getState(), null, 2);
    }

    function importState(json) {
      const data = JSON.parse(json);
      if (!data || typeof data !== 'object') throw new Error('Invalid JSON');
      saveState({ ...defaultState(), ...data });
    }

    function reset() { saveState(defaultState()); }

    window.Storage = {
      getState,
      update,
      record: recordEvent,
      reflect: setReflection,
      score: setScore,
      complete: markCompleted,
      attempt: incrementAttempts,
      achieve: addAchievement,
      export: exportState,
      import: importState,
      reset
    };
  })();
  </script>

  <script>
  (function(){
    const defaultPrompts = {
      geral: [
        'Explique sua lógica passo a passo em voz alta.',
        'O que é essencial nesta situação e o que você pode ignorar?',
        'Se mudássemos o contexto, sua solução ainda faria sentido?'
      ],
      padroes: [
        'Esse comportamento se repete em outros exemplos?',
        'Se fosse prever o próximo valor, em que base você se apoiaria?',
        'O crescimento é constante? O quanto varia a cada passo?'
      ],
      abstracao: [
        'Quais dados você pode descartar sem prejudicar sua análise?',
        'Como representaria o problema de forma resumida para alguém de fora?',
        'Se só restasse essa informação, sua solução ainda faria sentido?'
      ],
      algoritmo: [
        'A ordem dos passos está lógica para qualquer pessoa que siga?',
        'Se algo der errado no meio, seu algoritmo prevê alternativas?',
        'Teste passo a passo: em qual momento seu plano falha?'
      ],
      generalizacao: [
        'Em que outros contextos essa regra pode funcionar?',
        'O que mudaria se as condições fossem diferentes?',
        'Qual é a lógica que continua igual mesmo mudando o cenário?'
      ],
      robotica: [
        'Robôs percebem com sensores e atuam com atuadores.',
        'Qual sensor/atuador se aplica aqui e por quê?',
        'Que condição dispara a ação do robô?'
      ]
    };

    function mountTip(selector, { pillar = 'geral', level = 'Cue', prompts } = {}) {
      const el = document.querySelector(selector);
      if (!el) return;
      const items = prompts && prompts.length ? prompts : defaultPrompts[pillar] || defaultPrompts.geral;
      const current = items[Math.floor(Math.random() * items.length)];
      el.innerHTML = `
        <div>
          <div class="badge">${level}</div>
          <div>${current}</div>
        </div>
      `;
    }

    function defaultPromptsFor(pillar) {
      return defaultPrompts[pillar] || defaultPrompts.geral;
    }

    window.TipEngine = { mountTip, defaultPromptsFor };
  })();
  </script>

  <script>
  (function(){
    const appEl = document.getElementById('app');
    const navLinks = Array.from(document.querySelectorAll('nav.main-nav a[data-route]'));

    function setActiveNav(hash) {
      navLinks.forEach(a => {
        if (a.getAttribute('href') === hash) a.classList.add('active');
        else a.classList.remove('active');
      });
    }

    const routes = {
      '/': renderHome,
      '/padroes': renderPadroes,
      '/abstracao': renderAbstracao,
      '/algoritmo': renderAlgoritmo,
      '/generalizacao': renderGeneralizacao,
      '/robotica': renderRobotica,
      '/relatorios': renderReports,
      '/ajustes': renderSettings
    };

    function router() {
      const raw = window.location.hash.replace('#', '') || '/';
      const path = raw.split('?')[0];
      const route = routes[path] ? path : '/';
      setActiveNav(`#${route}`);
      routes[route]();
    }

    window.addEventListener('hashchange', router);
    window.addEventListener('load', () => {
      router();
    });

    function renderHome() {
      const stats = Storage.getState();
      appEl.innerHTML = `
        <section class="grid cols-2">\n          <div class="card">\n            <h1>Bem-vindo(a) ao MAPEAR</h1>\n            <p>Plataforma de minijogos para desenvolver <strong>Abstração</strong>, <strong>Reconhecimento de Padrões</strong>, <strong>Pensamento Algorítmico</strong> e <strong>Generalização</strong>.</p>\n            <div class="tip" style="margin-top:10px;">\n              <div>\n                <div class="badge">Mentores virtuais</div>\n                <div><b>Mentores virtuais:</b><br>- Abstração: Ver além dos detalhes.<br>- Padrões: Encontrar regularidades.<br>- Generalização: Expandir soluções.<br>- Algoritmos: Planejar passo a passo.<br>- Robótica: Interagir através de sensores e atuadores.</div>\n              </div>\n            </div>\n          </div>\n          <div class="card">\n            <h2>Sua jornada</h2>\n            <ul class="list">\n              <li>Detective de Padrões: <strong>${stats.progress.padroes.completed ? 'Concluído' : 'Não realizado'}</strong></li>\n              <li>Abstração: <strong>${stats.progress.abstracao.completed ? 'Concluído' : 'Não realizado'}</strong></li>\n              <li>Algoritmos: <strong>${stats.progress.algoritmo.completed ? 'Concluído' : 'Não realizado'}</strong></li>\n              <li>Generalize+: <strong>${stats.progress.generalizacao.completed ? 'Concluído' : 'Não realizado'}</strong></li>\n              <li>Robótica: <strong>${stats.progress.robotica.completed ? 'Concluído' : 'Não realizado'}</strong></li>\n            </ul>\n            <div style="margin-top:10px; display:flex; gap:10px;">\n              <a id="home-start" class="button" href="#/padroes">Começar agora</a>\n              <a class="button secondary" href="#/relatorios">Ver relatórios</a>\n            </div>\n            <div style="margin-top:10px;">\n              <button id="home-reset" class="button danger">Recomeçar jogos</button>\n            </div>\n          </div>\n        </section>
      `;
      const startBtn = document.querySelector('#home-start');
      if (startBtn) {
        startBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          Storage.reset();
          router();
          window.location.hash = '#/padroes';
        });
      }
      const resetBtn = document.querySelector('#home-reset');
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          Storage.reset();
          router();
        });
      }
    }

    function renderComingSoon(title, key) {
      appEl.innerHTML = `
        <section class="card">
          <h1>${title}</h1>
          <p class="muted">Carregando minijogo...</p>
          <div id="soon-tip" style="margin-top:10px;"></div>
          <div style="margin-top:16px; display:flex; gap:10px;">
            <a class="button" href="#/">Voltar</a>
          </div>
        </section>
      `;
      TipEngine.mountTip('#soon-tip', {
        pillar: key,
        level: 'Hint',
        prompts: TipEngine.defaultPromptsFor(key)
      });
    }

    function renderPadroes() {
      const phases = [
        { sequence: [50, 100, 150, 200], options: [210, 250, 300, 400], answer: 250, message: 'Diferença constante de 50.' },
        { sequence: [2, 4, 8, 16], options: [24, 28, 32, 36], answer: 32, message: 'Progressão multiplicativa (x2).' },
        { sequence: [3, 6, 9, 12], options: [13, 14, 15, 18], answer: 15, message: 'Múltiplos de 3.' },
        { sequence: [1, 1, 2, 3, 5], options: [6, 7, 8, 9], answer: 8, message: 'Sequência de Fibonacci.' },
        { sequence: [1, 4, 9, 16], options: [20, 24, 25, 30], answer: 25, message: 'Quadrados perfeitos.' },
        { sequence: [10, 7, 14, 11], options: [16, 18, 19, 20], answer: 18, message: 'Alterna +7 e -3.' },
        { sequence: [1, 3, 9, 27], options: [54, 72, 81, 90], answer: 81, message: 'Progressão geométrica (x3).' },
        { sequence: [2, 5, 9, 14], options: [18, 19, 20, 21], answer: 20, message: 'Diferença cresce +1 a cada etapa (3,4,5,6...).' },
        { sequence: [3, 5, 10, 12, 24], options: [22, 26, 28, 30], answer: 26, message: 'Alterna +2 e x2.' },
        { sequence: [3, 8, 15, 24], options: [32, 34, 35, 36], answer: 35, message: 'Diferenças ímpares crescentes (+5, +7, +9, +11).' },
        { sequence: [2, 4, 6, 8], options: [10, 9, 12, 11], answer: 10, message: 'A sequência soma 2.' },
        { sequence: ['andar', 'virar', 'andar', 'virar'], options: ['Andar', 'Virar', 'Parar', 'Voltar'], answer: 'Andar', message: 'O ciclo é andar, virar, andar, virar.' },
        { sequence: ['A', 'C', 'E', 'G'], options: ['H', 'I', 'J','F'], answer: 'I', message: 'Avança de 2 em 2 letras: I.' },
        { sequence: ['Chega cedo', 'Senta na janela', 'Chega tarde', 'Senta no meio', 'Chega cedo'], options: ['Senta na janela', 'Senta no meio', 'Chega tarde', 'Chega cedo'], answer: 'Senta na janela', message: 'O padrão observado é: cedo = janela.' },
        { situacao: 'Durante a semana, você percebe que o ônibus chega sempre às 7h30.', pergunta: 'Qual é o padrão observado?', opcoes: ['O ônibus é azul', 'Chega sempre às 7h30', 'Os passageiros falam alto', 'O motorista é simpático'], resposta: 'Chega sempre às 7h30', dica: 'Padrões são eventos ou comportamentos que se repetem.', reflexao: 'Como identificar padrões ajuda a planejar seu dia?' },
        { situacao: 'No calendário, os feriados nacionais acontecem sempre em datas fixas ou seguem regras específicas.', pergunta: 'Qual é o padrão que se observa?', opcoes: ['Todos caem no domingo', 'Alguns têm datas fixas, outros seguem regras', 'Sempre são em janeiro', 'Todos são sexta-feira'], resposta: 'Alguns têm datas fixas, outros seguem regras', dica: 'Observe regularidades mesmo que haja variações.', reflexao: 'Como padrões de datas podem facilitar a organização de eventos?' },
        { situacao: 'Ao organizar seus livros, você percebe que todos os de ficção estão na prateleira de cima e todos de não-ficção na de baixo.', pergunta: 'Qual padrão está sendo seguido?', opcoes: ['Altura da prateleira', 'Gênero do livro', 'Cor da capa', 'Tamanho do livro'], resposta: 'Gênero do livro', dica: 'Padrões ajudam a categorizar e organizar informações.', reflexao: 'Como identificar padrões facilita achar informações rapidamente?' },
        { situacao: 'Em uma sequência de cores no semáforo: vermelho, amarelo, verde, vermelho, amarelo, verde...', pergunta: 'Qual é o padrão da sequência?', opcoes: ['A cor favorita do motorista', 'Repetição das cores vermelho, amarelo e verde', 'Hora do dia', 'Número de carros na rua'], resposta: 'Repetição das cores vermelho, amarelo e verde', dica: 'Procure repetições ou ciclos regulares.', reflexao: 'Como reconhecer ciclos ajuda em situações cotidianas?' },
        { situacao: 'Durante uma aula de matemática, os números pares e ímpares aparecem alternadamente na lousa: 2, 3, 4, 5, 6, 7...', pergunta: 'Qual padrão você identifica?', opcoes: ['A cor da lousa', 'Alternância de números pares e ímpares', 'Número de alunos na sala', 'Dia da semana'], resposta: 'Alternância de números pares e ímpares', dica: 'Padrões podem ser numéricos, espaciais ou temporais.', reflexao: 'Como observar padrões numéricos ajuda na resolução de problemas?' },
        { situacao: 'No trânsito, o semáforo muda sempre na mesma ordem: vermelho → verde → amarelo → vermelho...', pergunta: 'Qual padrão é observado?', opcoes: ['Cores aleatórias', 'Sequência repetitiva das cores', 'A velocidade dos carros', 'O horário do almoço do motorista'], resposta: 'Sequência repetitiva das cores', dica: 'Ciclos repetitivos indicam padrões.', reflexao: 'Como reconhecer padrões no trânsito pode melhorar a segurança?' },
        { situacao: 'Você percebe que sempre que chove, o chão do quintal fica molhado e os sapatos sujam.', pergunta: 'Qual padrão está ocorrendo?', opcoes: ['Sapatos sempre limpos', 'Chuva leva à sujeira no chão e sapatos', 'O sol nasce', 'As plantas crescem mais'], resposta: 'Chuva leva à sujeira no chão e sapatos', dica: 'Padrões podem mostrar relações de causa e efeito.', reflexao: 'Como observar padrões causa-efeito ajuda na tomada de decisões?' },
        { situacao: 'Em uma sequência de dias, segunda, quarta, sexta, segunda, quarta, sexta...', pergunta: 'Qual padrão você identifica?', opcoes: ['Dias alternados', 'Todos os dias da semana', 'Fins de semana repetidos', 'Dias aleatórios'], resposta: 'Dias alternados', dica: 'Observe regularidades em séries temporais.', reflexao: 'Como identificar padrões temporais ajuda a planejar sua semana?' },
        { situacao: 'Na fila da cantina, você percebe que sempre há um aluno de cada turma na frente.', pergunta: 'Qual é o padrão observado?', opcoes: ['Alunos de uma turma juntos', 'Alunos alternam turmas', 'Todos compram o mesmo lanche', 'Sempre há um professor na fila'], resposta: 'Alunos alternam turmas', dica: 'Padrões podem ser observados na posição ou sequência de elementos.', reflexao: 'Como reconhecer padrões em grupos ajuda na organização?' },
        { situacao: 'Você nota que seu celular sempre toca com o mesmo som quando recebe mensagens de um amigo específico.', pergunta: 'Qual padrão é identificado?', opcoes: ['Som aleatório', 'Som específico para aquele amigo', 'Volume muda sozinho', 'Tela pisca'], resposta: 'Som específico para aquele amigo', dica: 'Padrões podem estar ligados a sinais ou alertas repetitivos.', reflexao: 'Como padrões em notificações ajudam a reconhecer rapidamente mensagens importantes?' },
        { situacao: 'Ao digitar senhas, você percebe que sempre usa letras maiúsculas no início e números no final.', pergunta: 'Qual padrão está seguindo?', opcoes: ['Usa letras aleatórias', 'Sempre letras maiúsculas no início e números no final', 'Números aleatórios no meio', 'Tudo minúsculo'], resposta: 'Sempre letras maiúsculas no início e números no final', dica: 'Padrões podem estar na estrutura de informações.', reflexao: 'Como identificar padrões em comportamentos ajuda na automação de tarefas?' },
        { situacao: 'Você percebe que, no horário de almoço, a cantina sempre serve arroz, feijão e carne.', pergunta: 'Qual padrão alimentar se repete?', opcoes: ['A refeição muda todo dia', 'Arroz, feijão e carne sempre servidos', 'Só sobremesa', 'Todos comem salada'], resposta: 'Arroz, feijão e carne sempre servidos', dica: 'Padrões podem ocorrer em hábitos ou rotinas diárias.', reflexao: 'Como padrões alimentares ajudam a organizar refeições?' },
        { situacao: 'Em uma série de luzes piscando: acesa, apagada, acesa, apagada...', pergunta: 'Qual padrão você observa?', opcoes: ['Luz acesa sempre', 'Luz apagada sempre', 'Alternância acesa-apagada', 'Pisca aleatoriamente'], resposta: 'Alternância acesa-apagada', dica: 'Procure repetições regulares no tempo.', reflexao: 'Como padrões de sinais luminosos são usados em segurança e tecnologia?' },
        { situacao: 'Durante a semana, você percebe que certos ônibus estão sempre lotados às 7h e outros às 18h.', pergunta: 'Qual padrão está acontecendo?', opcoes: ['Todos os ônibus têm o mesmo número de passageiros', 'Certos horários sempre lotados', 'A cor dos ônibus muda', 'Motoristas alternam entre ônibus'], resposta: 'Certos horários sempre lotados', dica: 'Padrões podem ser temporais e relacionados à demanda.', reflexao: 'Como observar padrões de uso ajuda no planejamento de transporte?' },
        { situacao: 'Em um quadro de horários, as aulas de matemática sempre acontecem nas segundas e quartas.', pergunta: 'Qual padrão é identificado?', opcoes: ['Matemática só na sexta', 'Aulas alternadas nas segundas e quartas', 'Todas as aulas na segunda', 'Nenhuma regra'], resposta: 'Aulas alternadas nas segundas e quartas', dica: 'Padrões podem indicar repetição regular de eventos.', reflexao: 'Como padrões nos horários escolares ajudam a organizar estudos?' }
      ];
      let step = 1;
      try {
        const params = new URLSearchParams((window.location.hash.split('?')[1] || ''));
        const faseParam = parseInt(params.get('fase') || '1', 10);
        if (!Number.isNaN(faseParam) && faseParam >= 1 && faseParam <= phases.length) {
          step = faseParam;
        }
      } catch {}
      let attempts = 0;
      let corrects = 0;
      appEl.innerHTML = `
        <section class="card">
          <h1>Detective de Padrões</h1>
          <div class="muted" id="padroes-phase">Fase 1 de ${phases.length}</div>
          <div style="margin-top:8px;">
            <label for="padroes-jump">Ir para fase:</label>
            <select id="padroes-jump" class="input" style="max-width:120px; display:inline-block; margin-left:8px;"></select>
          </div>
          <p id="padroes-instrucao">Complete a sequência:</p>
          <div id="padroes-seq" style="font-size:18px; margin:8px 0;"></div>
          <div id="padroes-options" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;"></div>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button id="padroes-verificar" class="button" style="display:none;">Verificar</button>
          </div>
          <div id="padroes-feedback" class="muted" style="margin-top:10px;"></div>
          <div class="tip" style="margin-top:12px;">
            <div>
              <div id="padroes-tip"></div>
            </div>
          </div>
          <div style="margin-top:14px;">
            <label for="padroes-reflexao">Reflexão (MAPEAR):</label>
            <textarea id="padroes-reflexao" class="input" rows="3" placeholder="Como identificou o padrão? O que ignorou?"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <button id="padroes-salvar" class="button secondary" disabled>Salvar reflexão</button>
              <a id="padroes-prosseguir" class="button" href="#/abstracao" style="display:none;">Próximo: Abstração</a>
            </div>
          </div>
        </section>
      `;
      const seqEl = document.getElementById('padroes-seq');
      const instrEl = document.getElementById('padroes-instrucao');
      const phaseEl = document.getElementById('padroes-phase');
      const optsEl = document.getElementById('padroes-options');
      const feedbackEl = document.getElementById('padroes-feedback');
      const reflexEl = document.getElementById('padroes-reflexao');
      const saveBtn = document.getElementById('padroes-salvar');
      const nextLink = document.getElementById('padroes-prosseguir');
      const jumpEl = document.getElementById('padroes-jump');
      const verifyBtn = document.getElementById('padroes-verificar');

      if (jumpEl) {
        for (let i = 1; i <= phases.length; i++) {
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = String(i);
          if (i === step) opt.selected = true;
          jumpEl.appendChild(opt);
        }
        jumpEl.addEventListener('change', () => {
          const next = parseInt(jumpEl.value, 10);
          if (!Number.isNaN(next)) {
            step = Math.max(1, Math.min(phases.length, next));
            if (history && history.replaceState) {
              history.replaceState(null, '', `#/padroes?fase=${step}`);
            }
            renderPhase();
          }
        });
      }

      function renderPhase() {
        const current = phases[step - 1];
        phaseEl.textContent = `Fase ${step} de ${phases.length}`;
        if (jumpEl) jumpEl.value = String(step);
        const isSequence = Array.isArray(current.sequence);
        if (instrEl) instrEl.textContent = isSequence ? 'Complete a sequência:' : 'Identifique o padrão:';
        if (isSequence) {
          seqEl.innerHTML = `${current.sequence.join(', ')}, <strong>?</strong>`;
        } else {
          const situacao = current.situacao ? String(current.situacao) : '';
          const pergunta = current.pergunta ? String(current.pergunta) : '';
          seqEl.innerHTML = `<p class=\"muted\">${situacao}</p><p><strong>${pergunta}</strong></p>`;
        }
        optsEl.innerHTML = '';
        feedbackEl.textContent = '';
        TipEngine.mountTip('#padroes-tip', { pillar: 'padroes', level: 'Hint' });
        if (isSequence) {
          if (verifyBtn) verifyBtn.style.display = 'none';
          (current.options || current.opcoes || []).forEach(value => {
            const btn = document.createElement('button');
            btn.className = 'button';
            btn.textContent = String(value);
            btn.addEventListener('click', () => {
              attempts += 1;
              Storage.attempt('padroes');
              if (value === current.answer || value === current.resposta) {
                corrects += 1;
                if (step < phases.length) {
                  Storage.record('minigame_step', { key: 'padroes', step, correct: true });
                  const successMsg = current.message || current.dica || 'Padrão identificado.';
                  feedbackEl.innerHTML = `<span style=\"color: var(--ok);\">Certo! ${successMsg} Próxima fase...</span>`;
                  step += 1;
                  setTimeout(renderPhase, 2000);
                } else {
                  const mistakes = attempts - corrects;
                  const raw = Math.round(10 * phases.length / Math.max(attempts, 1));
                  const score = Math.max(0, Math.min(10, raw));
                  Storage.score('padroes', score);
                  Storage.complete('padroes');
                  Storage.achieve('Reconheceu padrões em múltiplas sequências');
                  Storage.record('minigame_result', { key: 'padroes', attempts, mistakes, correct: true });
                  const finalMsg = current.message || 'Você reconheceu padrões em múltiplos contextos.';
                  feedbackEl.innerHTML = `<span style=\"color: var(--ok);\">Concluído! ${finalMsg}</span>`;
                  saveBtn.disabled = false;
                  nextLink.style.display = 'inline-flex';
                }
              } else {
                Storage.record('minigame_try', { key: 'padroes', step, guess: value });
                const failMsg = (Array.isArray(current.sequence) ? 'Observe a variação entre os termos.' : 'Releia a situação e foque no que se repete.');
                feedbackEl.innerHTML = `<span style=\"color: var(--warning);\">Ainda não. ${failMsg}</span>`;
                TipEngine.mountTip('#padroes-tip', { pillar: 'padroes', level: 'Scaffold' });
              }
            });
            optsEl.appendChild(btn);
          });
        } else {
          // texto/situação: render como rádio + botão Verificar
          if (verifyBtn) verifyBtn.style.display = 'inline-flex';
          (current.options || current.opcoes || []).forEach((value, idx) => {
            const wrapper = document.createElement('label');
            wrapper.style.display = 'flex';
            wrapper.style.alignItems = 'center';
            wrapper.style.gap = '8px';
            const input = document.createElement('input');
            input.type = 'radio';
            input.name = 'padroes-option';
            input.value = String(value);
            input.id = `padroes-opt-${idx}`;
            const text = document.createElement('span');
            text.textContent = String(value);
            wrapper.appendChild(input);
            wrapper.appendChild(text);
            optsEl.appendChild(wrapper);
          });
          if (verifyBtn) {
            verifyBtn.onclick = () => {
              const selected = /** @type {HTMLInputElement|null} */ (document.querySelector('input[name="padroes-option"]:checked'));
              if (!selected) {
                feedbackEl.innerHTML = `<span style=\"color: var(--warning);\">Selecione uma opção.</span>`;
                return;
              }
              const guess = selected.value;
              attempts += 1;
              Storage.attempt('padroes');
              if (guess === String(current.answer || current.resposta)) {
                corrects += 1;
                if (step < phases.length) {
                  Storage.record('minigame_step', { key: 'padroes', step, correct: true });
                  const successMsg = current.message || current.dica || 'Padrão identificado.';
                  feedbackEl.innerHTML = `<span style=\"color: var(--ok);\">Certo! ${successMsg} Próxima fase...</span>`;
                  step += 1;
                  setTimeout(renderPhase, 2000);
                } else {
                  const mistakes = attempts - corrects;
                  const raw = Math.round(10 * phases.length / Math.max(attempts, 1));
                  const score = Math.max(0, Math.min(10, raw));
                  Storage.score('padroes', score);
                  Storage.complete('padroes');
                  Storage.achieve('Reconheceu padrões em múltiplas sequências');
                  Storage.record('minigame_result', { key: 'padroes', attempts, mistakes, correct: true });
                  const finalMsg = current.message || 'Você reconheceu padrões em múltiplos contextos.';
                  feedbackEl.innerHTML = `<span style=\"color: var(--ok);\">Concluído! ${finalMsg}</span>`;
                  saveBtn.disabled = false;
                  nextLink.style.display = 'inline-flex';
                }
              } else {
                Storage.record('minigame_try', { key: 'padroes', step, guess });
                const failMsg = 'Releia a situação e foque no que se repete.';
                feedbackEl.innerHTML = `<span style=\"color: var(--warning);\">Ainda não. ${failMsg}</span>`;
                TipEngine.mountTip('#padroes-tip', { pillar: 'padroes', level: 'Scaffold' });
              }
            };
          }
        }
      }

      saveBtn.addEventListener('click', () => {
        Storage.reflect('padroes', reflexEl.value.trim());
        feedbackEl.innerHTML = 'Reflexão salva.';
      });

      renderPhase();
    }

    function renderAbstracao() {
      const phases = [
        {
          prompt: 'Marque apenas as informações relevantes para responder: <em>"A prefeitura se preparou para o evento?"</em>',
          items: [
            { id: 'pessoas', label: 'O show da banda atraiu 10 mil pessoas.', relevant: false },
            { id: 'prep', label: 'A prefeitura investiu em segurança e limpeza.', relevant: true },
            { id: 'roupa', label: 'O vocalista é de esquerda.', relevant: false },
            { id: 'guardas', label: 'Houve 50 guardas presentes.', relevant: true }
          ]
        },
        {
          prompt: 'Marque o essencial para decidir se há <em>alerta climático</em> válido para hoje.',
          items: [
            { id: 'chuva', label: 'Previsão de chuva intensa e ventos fortes.', relevant: true },
            { id: 'foto', label: 'A foto do post mostra um arco-íris.', relevant: false },
            { id: 'alerta', label: 'Defesa Civil emitiu alerta para hoje.', relevant: true },
            { id: 'curiosidade', label: 'A cidade tem 300 anos.', relevant: false }
          ]
        },
        {
          prompt: 'Para decidir se <em>vale a pena comprar</em>, marque apenas dados financeiros essenciais.',
          items: [
            { id: 'preco', label: 'Preço atual com desconto de 20%.', relevant: true },
            { id: 'cor', label: 'O equipamento é top de linha.', relevant: false },
            { id: 'garantia', label: 'Garantia estendida de 2 anos por R$ 150.', relevant: true },
            { id: 'embalagem', label: 'Embalagem sustentável.', relevant: false }
          ]
        },
        {
          prompt: 'Marque o essencial para decidir se há <em>risco de trânsito</em> na rota agora.',
          items: [
            { id: 'waze', label: 'Aplicativo indica congestionamento de 7 km.', relevant: true },
            { id: 'musica', label: 'Distância até o destino.', relevant: false },
            { id: 'acidente', label: 'Registro de acidente no quilômetro 25.', relevant: true },
            { id: 'paisagem', label: 'Vista bonita da serra.', relevant: false }
          ]
        },
        {
          prompt: 'Aprovação de <em>empréstimo</em>: selecione somente evidências essenciais.',
          items: [
            { id: 'renda', label: 'Renda comprovada acima do mínimo.', relevant: true },
            { id: 'likes', label: 'Número de horas trabalhadas.', relevant: false },
            { id: 'credito', label: 'Histórico de crédito sem inadimplência.', relevant: true },
            { id: 'corcartao', label: 'Quantidade de filhos.', relevant: false }
          ]
        },
        {
          prompt: 'Acesso a <em>laboratório</em>: marque requisitos essenciais.',
          items: [
            { id: 'cracha', label: 'Crachá válido com autorização.', relevant: true },
            { id: 'epi', label: 'Uso de equipamentos de proteção (EPI).', relevant: true },
            { id: 'playlist', label: 'Tipo de roupa escolhida.', relevant: false },
            { id: 'selfie', label: 'Foto bonita no crachá.', relevant: false }
          ]
        },
        {
          prompt: 'Verificar se a <em>fonte</em> é confiável: selecione apenas evidências válidas.',
          items: [
            { id: 'gov', label: 'Endereço institucional (.gov) ou DOI.', relevant: true },
            { id: 'likes2', label: 'Muitos likes e comentários.', relevant: false },
            { id: 'refs', label: 'Referências bibliográficas citadas.', relevant: true },
            { id: 'emoji', label: 'Texto escrito por uma IA.', relevant: false }
          ]
        },
        {
          prompt: 'Avaliar <em>risco de incêndio</em>: selecione dados essenciais.',
          items: [
            { id: 'umidade', label: 'Umidade do ar muito baixa.', relevant: true },
            { id: 'corcarro', label: 'Carro estacionado próximo ao local.', relevant: false },
            { id: 'feriado', label: 'Data é feriado municipal.', relevant: false },
            { id: 'temperatura', label: 'Temperatura ambiente elevada.', relevant: true }
          ]
        },
        {
          prompt: 'Triagem em <em>pronto atendimento</em>: selecione dados essenciais de urgência.',
          items: [
            { id: 'saturacao', label: 'Saturação de O2 abaixo de 90%.', relevant: true },
            { id: 'roupa2', label: 'Tipo da roupa do paciente.', relevant: false },
            { id: 'historico', label: 'Histórico de alergia a poeira.', relevant: false },
            { id: 'dor', label: 'Dor torácica intensa súbita.', relevant: true }
          ]
        },
        {
          prompt: 'Validação de <em>experimento</em>: selecione evidências metodológicas essenciais.',
          items: [
            { id: 'controle', label: 'Grupo de controle presente.', relevant: true },
            { id: 'amostra', label: 'Tamanho de amostra adequado.', relevant: true },
            { id: 'thumbnail', label: 'Propaganda do produto chamativa.', relevant: false },
            { id: 'musica3', label: 'Usuários de alta classe.', relevant: false }
          ]
        },
        {
          prompt: 'Lista de itens: [arroz, panela, colher, cozinhar, família, mesa]. O que é essencial para a receita?',
          items: [
            { id: 'arroz', label: 'Arroz, panela e cozinhar', relevant: true },
            { id: 'arroz2', label: 'Panela, colher e cozinhar', relevant: false },
            { id: 'familia', label: 'Panela, mesa e colher', relevant: false },
            { id: 'panela', label: 'Colher, mesa e família', relevant: false }
          ]
        },
        {
          prompt: 'Uma bicicleta: [rodas, guidão, cor azul, adesivo]. Qual a abstração correta?',
          items: [
            { id: 'rodas_guidao', label: 'Rodas, selim e guidão', relevant: true },
            { id: 'estetica', label: 'Rodas, selim e adesivo', relevant: false },
            { id: 'estetica2', label: 'Cor, rodas e guidão', relevant: false },
            { id: 'adesivo', label: 'Adesivo, selim e guidão', relevant: false }
          ]
        },
        {
          prompt: 'App de banco: quais dados são essenciais no cadastro inicial?',
          items: [
            { id: 'essenciais', label: 'Nome completo, CPF, endereço, senha', relevant: true },
            { id: 'irrelevantes1', label: 'Nome completo, endereço, signo', relevant: false },
            { id: 'irrelevantes3', label: 'Nome completo, senha, estado civil', relevant: false },
            { id: 'irrelevantes2', label: 'Nome completo, foto atual, apelido', relevant: false }
          ]
        },
        {
          prompt: 'Jogo de futebol: qual abstração é correta?',
          items: [
            { id: 'nucleo', label: 'Bola, jogadores, regras', relevant: true },
            { id: 'uniforme', label: 'jogadores, estádio, placar', relevant: false },
            { id: 'uniforme2', label: 'regras, estádio, placar', relevant: false },
            { id: 'musica', label: 'Música da torcida, placar, regras', relevant: false }
          ]
        }
        ,
        {
          prompt: 'App de academia: quais dados são essenciais no cadastro?',
          items: [
            { id: 'bank_nome_cpf_senha', label: 'Nome, CPF, endereço, atestado médico', relevant: true },
            { id: 'bank_peso_altura_signo', label: 'Nome, peso, altura, signo', relevant: false },
            { id: 'bank_nome_cpf_signo', label: 'Nome, CPF, signo', relevant: false },
            { id: 'bank_cachorro', label: 'Nome, foto do perfil, endereço', relevant: false }
          ]
        }
        ,
        {
          prompt: 'Situação: Você precisa organizar uma feira de ciências na escola. Há dezenas de detalhes (alimentação, decoração).<br><strong>Pergunta:</strong> Qual é o primeiro passo aplicando abstração?',
          items: [
            { id: 'feira_comida', label: 'Comprar comida', relevant: false },
            { id: 'feira_elementos', label: 'Identificar elementos principais do evento', relevant: true },
            { id: 'feira_idade', label: 'Listar alunos por idade', relevant: false },
            { id: 'feira_cores', label: 'Definir cores da decoração', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Um professor recebe várias redações com erros de ortografia, estilo e conteúdo.<br><strong>Pergunta:</strong> O que seria abstrair?',
          items: [
            { id: 'redacao_virgulas', label: 'Corrigir vírgulas', relevant: false },
            { id: 'redacao_ideia', label: 'Analisar ideia central', relevant: true },
            { id: 'redacao_letra', label: 'Avaliar letra bonita', relevant: false },
            { id: 'redacao_tamanho', label: 'Ver tamanho do texto', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Você vai estudar para uma prova com 200 páginas de conteúdo.<br><strong>Pergunta:</strong> Como usar abstração?',
          items: [
            { id: 'prova_todas', label: 'Ler todas as páginas', relevant: false },
            { id: 'prova_resumos', label: 'Estudar apenas títulos e resumos', relevant: true },
            { id: 'prova_paginas', label: 'Memorizar número de páginas', relevant: false },
            { id: 'prova_copiar', label: 'Copiar tudo no caderno', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Um aplicativo precisa organizar músicas por gênero, cantor e álbum.<br><strong>Pergunta:</strong> Qual abstração mais útil?',
          items: [
            { id: 'musica_cachorro', label: 'Nome do cachorro do cantor', relevant: false },
            { id: 'musica_fa', label: 'Data de nascimento do fã', relevant: false },
            { id: 'musica_genero', label: 'Gênero musical', relevant: true },
            { id: 'musica_onibus', label: 'Número do ônibus do cantor', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Uma escola vai implantar energia solar.<br><strong>Pergunta:</strong> O que abstrair?',
          items: [
            { id: 'solar_cor', label: 'Cor do telhado', relevant: false },
            { id: 'solar_placas', label: 'Quantidade de placas solares', relevant: true },
            { id: 'solar_nomes', label: 'Nome dos alunos', relevant: false },
            { id: 'solar_uniformes', label: 'Formato dos uniformes', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Uma pesquisa coleta dados sobre esportes favoritos de 200 alunos.<br><strong>Pergunta:</strong> Qual abstração correta?',
          items: [
            { id: 'esportes_nomes', label: 'Nome de cada aluno', relevant: false },
            { id: 'esportes_contagem', label: 'Contar quantos gostam de cada esporte', relevant: true },
            { id: 'esportes_aniversario', label: 'Aniversário de cada aluno', relevant: false },
            { id: 'esportes_altura', label: 'Altura dos participantes', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Um programador cria um jogo de corrida.<br><strong>Pergunta:</strong> Qual elemento é essencial na abstração?',
          items: [
            { id: 'corrida_cor', label: 'Cor do carro', relevant: false },
            { id: 'corrida_regras', label: 'Regras da corrida', relevant: true },
            { id: 'corrida_nomes', label: 'Nome dos jogadores', relevant: false },
            { id: 'corrida_data', label: 'Data de lançamento', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Você cria uma lista de compras.<br><strong>Pergunta:</strong> O que é abstrair nesse caso?',
          items: [
            { id: 'compras_marca', label: 'Escrever a marca de cada produto', relevant: false },
            { id: 'compras_necessarios', label: 'Colocar apenas os produtos necessários', relevant: true },
            { id: 'compras_corredores', label: 'Registrar a ordem dos corredores do mercado', relevant: false },
            { id: 'compras_promocoes', label: 'Anotar promoções', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Uma equipe de robótica planeja um robô que joga futebol.<br><strong>Pergunta:</strong> Qual abstração correta?',
          items: [
            { id: 'robo_uniforme', label: 'Escolher uniforme do robô', relevant: false },
            { id: 'robo_regras', label: 'Definir regras básicas do jogo', relevant: true },
            { id: 'robo_tecnicos', label: 'Saber nome dos técnicos', relevant: false },
            { id: 'robo_cor_quadra', label: 'Escolher cor da quadra', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Você precisa estudar para três provas em uma semana.<br><strong>Pergunta:</strong> Qual abstração mais útil?',
          items: [
            { id: 'provas_priorizar', label: 'Analisar matérias que valem mais pontos', relevant: true },
            { id: 'provas_cores', label: 'Lembrar cor das capas dos cadernos', relevant: false },
            { id: 'provas_decorar', label: 'Decorar todos os textos sem prioridade', relevant: false },
            { id: 'provas_aleatorio', label: 'Estudar matérias aleatórias', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Uma professora prepara uma aula de meio ambiente.<br><strong>Pergunta:</strong> Qual abstração correta?',
          items: [
            { id: 'meioambiente_conceitos', label: 'Focar nos conceitos principais de reciclagem', relevant: true },
            { id: 'meioambiente_lei', label: 'Trazer todos os detalhes da legislação', relevant: false },
            { id: 'meioambiente_historia', label: 'Explicar toda a história do planeta', relevant: false },
            { id: 'meioambiente_lixo', label: 'Mostrar todos os tipos de lixo existentes', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Um app mostra previsão do tempo.<br><strong>Pergunta:</strong> Qual abstração útil?',
          items: [
            { id: 'clima_temp_chuva', label: 'Temperatura média e chuva', relevant: true },
            { id: 'clima_nascimento', label: 'Data de nascimento do usuário', relevant: false },
            { id: 'clima_tv', label: 'Horário da TV preferida', relevant: false },
            { id: 'clima_vizinho', label: 'Nome do vizinho', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Uma escola organiza transporte escolar.<br><strong>Pergunta:</strong> Qual abstração usar?',
          items: [
            { id: 'transporte_bairro', label: 'Número de alunos por bairro', relevant: true },
            { id: 'transporte_uniformes', label: 'Cor dos uniformes', relevant: false },
            { id: 'transporte_professores', label: 'Nome dos professores', relevant: false },
            { id: 'transporte_cadernos', label: 'Modelo dos cadernos', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Um time de esportes vai treinar.<br><strong>Pergunta:</strong> O que abstrair?',
          items: [
            { id: 'treino_regras', label: 'Regras principais do jogo', relevant: true },
            { id: 'treino_sapato', label: 'Sapato preferido de cada jogador', relevant: false },
            { id: 'treino_comida', label: 'Comida favorita de cada atleta', relevant: false },
            { id: 'treino_arquibancadas', label: 'Cor das arquibancadas', relevant: false }
          ]
        },
        {
          prompt: 'Situação: Um app de delivery organiza pedidos.<br><strong>Pergunta:</strong> Qual abstração correta?',
          items: [
            { id: 'delivery_nomes', label: 'Nome dos entregadores', relevant: false },
            { id: 'delivery_tempo', label: 'Tempo médio de entrega', relevant: true },
            { id: 'delivery_filmes', label: 'Filmes preferidos dos clientes', relevant: false },
            { id: 'delivery_sapato', label: 'Número do sapato do entregador', relevant: false }
          ]
        }
      ];
      let step = 1;
      try {
        const params = new URLSearchParams((window.location.hash.split('?')[1] || ''));
        const faseParam = parseInt(params.get('fase') || '1', 10);
        if (!Number.isNaN(faseParam)) step = Math.max(1, Math.min(phases.length, faseParam));
      } catch {}
      let attempts = 0;
      let corrects = 0;
      appEl.innerHTML = `
        <section class="card">
          <h1>Abstração</h1>
          <div class="muted" id="ab-phase">Fase 1 de ${phases.length}</div>
          <div style="margin-top:8px;">
            <label for="ab-jump">Ir para fase:</label>
            <select id="ab-jump" class="input" style="max-width:120px; display:inline-block; margin-left:8px;"></select>
          </div>
          <p id="ab-prompt"></p>
          <div id="ab-list" style="display:flex; flex-direction:column; gap:8px; margin-top:8px;"></div>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button id="ab-verificar" class="button">Verificar</button>
            <button id="ab-limpar" class="button secondary">Limpar</button>
            <a id="ab-prosseguir" class="button" href="#/algoritmo" style="display:none;">Próximo: Algoritmos</a>
          </div>
          <div id="ab-feedback" class="muted" style="margin-top:10px;"></div>
          <div class="tip" style="margin-top:12px;">
            <div>
              <div id="ab-tip"></div>
            </div>
          </div>
          <div style="margin-top:14px;">
            <label for="ab-reflexao">Reflexão (MAPEAR):</label>
            <textarea id="ab-reflexao" class="input" rows="3" placeholder="Quais dados descartou e por quê?"></textarea>
            <button id="ab-salvar" class="button secondary" disabled style="margin-top:8px;">Salvar reflexão</button>
          </div>
        </section>
      `;
      const phaseEl = document.getElementById('ab-phase');
      const promptEl = document.getElementById('ab-prompt');
      const listEl = document.getElementById('ab-list');
      const fb = document.getElementById('ab-feedback');
      const btnCheck = document.getElementById('ab-verificar');
      const btnClear = document.getElementById('ab-limpar');
      const btnNext = document.getElementById('ab-prosseguir');
      const reflexEl = document.getElementById('ab-reflexao');
      const saveBtn = document.getElementById('ab-salvar');
      const jumpEl = document.getElementById('ab-jump');

      if (jumpEl) {
        for (let i = 1; i <= phases.length; i++) {
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = String(i);
          if (i === step) opt.selected = true;
          jumpEl.appendChild(opt);
        }
        jumpEl.addEventListener('change', () => {
          const next = parseInt(jumpEl.value, 10);
          if (!Number.isNaN(next)) {
            step = Math.max(1, Math.min(phases.length, next));
            if (history && history.replaceState) {
              history.replaceState(null, '', `#/abstracao?fase=${step}`);
            }
            renderPhase();
          }
        });
      }

      function renderPhase() {
        const current = phases[step - 1];
        phaseEl.textContent = `Fase ${step} de ${phases.length}`;
        if (jumpEl) jumpEl.value = String(step);
        promptEl.innerHTML = current.prompt;
        listEl.innerHTML = '';
        fb.textContent = '';
        TipEngine.mountTip('#ab-tip', { pillar: 'abstracao', level: 'Hint' });
        current.items.forEach(item => {
          const label = document.createElement('label');
          label.style.display = 'flex';
          label.style.gap = '8px';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.id = `ab-${item.id}`;
          label.appendChild(cb);
          const span = document.createElement('span');
          span.textContent = item.label;
          label.appendChild(span);
          listEl.appendChild(label);
        });
      }

      btnCheck.addEventListener('click', () => {
        attempts += 1;
        Storage.attempt('abstracao');
        const current = phases[step - 1];
        const expected = new Set(current.items.filter(i => i.relevant).map(i => i.id));
        const selected = new Set(
          current.items.filter(i => document.getElementById(`ab-${i.id}`).checked).map(i => i.id)
        );
        const correct = selected.size === expected.size && [...expected].every(x => selected.has(x));
        if (correct) {
          corrects += 1;
          if (step < phases.length) {
            Storage.record('minigame_step', { key: 'abstracao', step, correct: true });
            fb.innerHTML = '<span style="color: var(--ok);">Certo! Próxima fase...</span>';
            step += 1;
            setTimeout(renderPhase, 2000);
          } else {
            const mistakes = attempts - corrects;
            const raw = Math.round(10 * phases.length / Math.max(attempts, 1));
            const score = Math.max(0, Math.min(10, raw));
            Storage.score('abstracao', score);
            Storage.complete('abstracao');
            Storage.achieve('Separou essencial do irrelevante em fases diversas');
            Storage.record('minigame_result', { key: 'abstracao', attempts, mistakes, correct: true });
            fb.innerHTML = '<span style="color: var(--ok);">Concluído! Você selecionou evidências essenciais.</span>';
            btnNext.style.display = 'inline-flex';
            saveBtn.disabled = false;
          }
        } else {
          Storage.record('minigame_try', { key: 'abstracao', step, selection: [...selected] });
          fb.innerHTML = '<span style="color: var(--warning);">Revise: foque apenas no que responde à pergunta.</span>';
          TipEngine.mountTip('#ab-tip', { pillar: 'abstracao', level: 'Scaffold' });
        }
      });

      btnClear.addEventListener('click', () => {
        const current = phases[step - 1];
        current.items.forEach(i => { document.getElementById(`ab-${i.id}`).checked = false; });
        fb.textContent = '';
      });

      saveBtn.addEventListener('click', () => {
        Storage.reflect('abstracao', reflexEl.value.trim());
        fb.innerHTML = 'Reflexão salva.';
      });

      renderPhase();
    }

    function renderAlgoritmo() {
      const blocks = [ 'Andar 2', 'Bater massa', 'Varredura linha 3', 'Andar 3','Esperar 30min','Varredura linha 1', 'Digitar', 'Digitar login', 'Virar esquerda',  'Varredura linha 2', 'Virar direita', 'Andar 1', 'Colocar saquinho de chá', 'Pré-aquecer forno','Digitar senha','Colocar a massa no forno', 'Servir','Ferver água', 'Colocar água fervida na xícara','Clicar em validar', 'Abrir perfil', 'Andar 4'];
      const phases = [
        { expected: ['Andar 2','Virar direita','Andar 1'], note: 'Plano curto e direto.' },
        { expected: ['Andar 2','Virar esquerda','Andar 2','Virar direita','Andar 1'], note: 'Inclui mudanças de direção mais de uma vez.' },
        { expected: ['Andar 1','Virar esquerda','Andar 2','Virar direita','Andar 2'], note: 'Mesmos movimentos do anterior, mudando a quantidade de passos.' },
        { expected: ['Andar 1','Virar direita','Andar 2','Virar esquerda','Andar 1','Virar direita','Andar 1'], note: 'Percurso com mudanças de direção.' },
        { expected: ['Andar 3','Virar direita','Andar 3'], note: 'Caminho com alternância de curvas e trechos longos.' },
        { expected: ['Andar 2','Virar direita','Andar 3','Virar esquerda','Andar 1','Virar direita','Andar 1'], note: 'Zigue-zague com trechos variados.' },
        { expected: ['Andar 1','Virar direita','Andar 2','Virar esquerda','Andar 2','Virar direita','Andar 2'], note: 'Sequência longa que exige atenção à ordem.' },
        { expected: ['Andar 3','Virar esquerda','Andar 3','Virar direita','Andar 1'], note: 'Contornando obstáculos' },
        { expected: ['Andar 2','Virar esquerda','Andar 3','Virar direita','Andar 2'], note: 'Caminho com obstáculos e trechos longos.' },
        { expected: ['Andar 1','Virar esquerda','Andar 2','Virar direita','Andar 3','Virar esquerda','Andar 1'], note: 'Percurso com zigue-zague e trechos longos.' },
        { expected: ['Ferver água','Colocar água fervida na xícara','Colocar saquinho de chá','Servir'], note: 'Chá: ordem correta é ferver antes de preparar.' },
        { expected: ['Pré-aquecer forno','Bater massa', 'Colocar a massa no forno','Esperar 30min','Servir'], note: 'Pré-aquecer antes de assar.' },
        { expected: ['Digitar login','Digitar senha','Clicar em validar'], note: 'Validar antes de abrir perfil.' },
        { expected: ['Varredura linha 1','Varredura linha 2','Varredura linha 3'], note: 'Varre linha a linha (3×3).'},
        { situacao: 'Você precisa ensinar um colega a ligar o projetor da sala.', pergunta: 'Marque o algoritmo que representa melhor as ações para solucionar o problema a seguir:', opcoes: ['Pressionar botão → Ligar na tomada → selecionar entrada', 'Ligar na tomada → apertar botão → selecionar entrada', 'Esperar aula começar  → apertar botão → selecionar entrada', 'Chamar técnico → apertar botão → selecionar entrada'], resposta: 'Ligar na tomada → apertar botão → selecionar entrada', dica: 'Pense em passos claros e ordenados.' },
        { situacao: 'Você quer fazer um café usando uma cafeteira elétrica.', pergunta: 'Qual sequência de passos representa um algoritmo?', opcoes: ['Colocar água e ligar cafeteira → colocar café → esperar', 'Colocar água e ligar cafeteira → esperar', 'Beber água fria → Colocar água quente e ligar cafeteira → colocar café → esperar', 'Escolher xícara → colocar café → esperar'], resposta: 'Colocar água e ligar cafeteira → colocar café → esperar', dica: 'Um algoritmo é uma sequência de ações que leva a um resultado.' },
        { situacao: 'Você precisa organizar os arquivos do computador por data.', pergunta: 'Qual algoritmo representa melhor a tarefa?', opcoes: ['Abrir pastas aleatoriamente → verificar data → mover arquivos → salvar', 'Abrir cada pasta → verificar data → mover arquivos → salvar', 'Abrir cada pasta → verificar data → mover arquivos → Apagar tudo', 'Abrir cada pasta → renomear pastas → mover arquivos → salvar'], resposta: 'Abrir cada pasta → verificar data → mover arquivos → salvar', dica: 'Defina a sequência lógica das ações.' },
        { situacao: 'Você vai cozinhar arroz no fogão.', pergunta: 'Qual algoritmo descreve corretamente o processo?', opcoes: ['Colocar arroz → ligar fogo → lava arroz', 'Lavar arroz → colocar água → ligar fogo → esperar cozinhar', 'Beber água → colocar água → ligar fogo → esperar cozinhar', 'ligar fogo → colocar água e café → esperar cozinhar'], resposta: 'Lavar arroz → colocar água → ligar fogo → esperar cozinhar', dica: 'Ordem dos passos é essencial em algoritmos.' },
        { situacao: 'Você precisa escovar os dentes.', pergunta: 'Qual sequência representa um algoritmo correto?', opcoes: ['Passar pasta → escovar → enxaguar', 'Escovar sem pasta → escovar → lavar → enxaguar → secar', 'Enxaguar → escovar → colocar pasta', 'Passar pasta → lavar escova → enxaguar'], resposta: 'Passar pasta → escovar → enxaguar', dica: 'Algoritmos descrevem processos claros e ordenados.' },
        { situacao: 'Você vai programar um robô para se mover em linha reta até uma parede.', pergunta: 'Qual algoritmo descreve melhor o movimento?', opcoes: ['Andar → fazer curva → parar', 'Girar → detectar parede → girar', 'Andar → detectar parede → parar', 'Parar → detectar parede → andar em frente'], resposta: 'Andar → detectar parede → parar', dica: 'Defina entradas, ações e saídas.' },
        { situacao: 'Você precisa organizar a mochila para a escola.', pergunta: 'Qual algoritmo representa melhor essa tarefa?', opcoes: ['Colocar roupas → cadernos → estojo → chapéu', 'Colocar sorvete → carros → bonecas → lanche', 'Colocar lanche → sapato → toalha', 'Colocar livros → cadernos → estojo → lanche'], resposta: 'Colocar livros → cadernos → estojo → lanche', dica: 'Siga uma sequência lógica para completar a tarefa.' },
        { situacao: 'Você quer trocar uma lâmpada queimada.', pergunta: 'Qual algoritmo descreve o processo correto?', opcoes: ['Retirar lâmpada → colocar nova → ligar energia','Desligar energia → retirar lâmpada → colocar nova → ligar energia', 'Desligar água → retirar lâmpada → colocar nova bateria → ligar energia', 'Apenas ligar a lâmpada queimada'], resposta: 'Desligar energia → retirar lâmpada → colocar nova → ligar energia', dica: 'Segurança é parte do algoritmo.' },
        { situacao: 'Você precisa preparar um sanduíche.', pergunta: 'Qual algoritmo representa corretamente a tarefa?', opcoes: ['Pão → queijo → presunto → pão', 'Pão → queijo → biscoito → pão', 'Pão → carro → queijo → presunto → pão', 'Cuscuz → manteiga'], resposta: 'Pão → queijo → presunto → pão', dica: 'Siga uma sequência lógica para atingir o objetivo.' },
        { situacao: 'Você quer programar o despertador para tocar todos os dias às 7h.', pergunta: 'Qual algoritmo descreve essa programação?', opcoes: ['Configurar hora → repetir diariamente → ativar', 'Ativar alarme → repetir diariamente → desativar', 'Configurar data, hora e alarme → repetir diariamente → ativar', 'Configurar hora → repetir diariamente → desativar'], resposta: 'Configurar hora → repetir diariamente → ativar', dica: 'Algoritmos incluem decisões e repetições quando necessário.' },
        { situacao: 'Você precisa enviar um e-mail com anexos importantes.', pergunta: 'Qual algoritmo representa melhor a ação?', opcoes: ['Abrir e-mail → escrever mensagem → anexar arquivos → enviar', 'Abrir e-mail → escrever mensagem → enviar', 'Abrir e-mail → escrever mensagem → anexar arquivos', 'Abrir e-mail → escrever mensagem → anexar arquivos → enviar'], resposta: 'Abrir e-mail → escrever mensagem → anexar arquivos → fechar', dica: 'Cada passo deve ser claro e ordenado.' },
        { situacao: 'Você vai plantar uma árvore no quintal.', pergunta: 'Qual algoritmo descreve melhor o processo?', opcoes: ['Cavar buraco → plantar muda → cobrir com terra → regar', 'Plantar muda → cobrir com terra → regar', 'Cavar buraco → cobrir com terra → regar', 'Cavar buraco → plantar muda → cobrir com terra → regar'], resposta: 'Cavar buraco → plantar muda → deixar secar', dica: 'Siga a sequência lógica de ações para garantir o resultado.' },
        { situacao: 'Você precisa preparar um suco de frutas.', pergunta: 'Qual algoritmo representa corretamente a preparação?', opcoes: ['Cortar frutas → liquidificar → servir', 'Lavar verduras → cortar → liquidificar → servir', 'Lavar frutas → cortar → liquidificar → jogar fora', 'Lavar frutas → cortar → liquidificar → servir'], resposta: 'Lavar frutas → cortar → liquidificar → servir', dica: 'Sequência de ações garante o resultado esperado.' },
        { situacao: 'Você precisa organizar um armário bagunçado.', pergunta: 'Qual algoritmo descreve melhor a organização?', opcoes: ['Retirar tudo → separar por categoria → guardar novamente', 'Retirar tudo → misturar por categoria → guardar novamente', 'Retirar tudo → separar por nome → guardar novamente', 'Retirar tudo → separar por sorte → guardar novamente'], resposta: 'Retirar tudo → separar por categoria → guardar novamente', dica: 'Algoritmos ajudam a estruturar tarefas complexas.' },
        { situacao: 'Você quer programar um robô para seguir uma linha preta no chão.', pergunta: 'Qual algoritmo representa melhor essa ação?', opcoes: ['Detectar linha → mover para frente → repetir', 'Detectar linha → ajustar direção → mover para frente → repetir', 'Detectar linha → dar ré → mover para frente → repetir', 'Detectar linha → ajustar direção → mover para frente → repetir'], resposta: 'Detectar linha → ajustar direção → mover para frente → repetir', dica: 'Algoritmos podem incluir repetição (loops) para atingir objetivos.' }
      ];
      let step = 1;
      try {
        const params = new URLSearchParams((window.location.hash.split('?')[1] || ''));
        const faseParam = parseInt(params.get('fase') || '1', 10);
        if (!Number.isNaN(faseParam)) step = Math.max(1, Math.min(phases.length, faseParam));
      } catch {}
      let plan = [];
      let scenarioChoice = null;
      let attempts = 0;
      let corrects = 0;
      appEl.innerHTML = `
        <section class="card">
          <h1>Algoritmos</h1>
          <div class="muted" id="alg-phase">Fase 1 de ${phases.length}</div>
          <div style="margin-top:8px;">
            <label for="alg-jump">Ir para fase:</label>
            <select id="alg-jump" class="input" style="max-width:120px; display:inline-block; margin-left:8px;"></select>
          </div>
          <p id="alg-instrucao">Monte um algoritmo para atravessar um labirinto simples.</p>
          <div style="margin-top:10px; display:flex; justify-content:center;">
            <img id="alg-image" src="./labirinto.png" alt="Representação do labirinto" style="max-width:420px; width:100%; height:auto; border-radius:10px; border:1px solid rgba(148,163,184,0.25); box-shadow:0 6px 18px rgba(0,0,0,0.25);" />
          </div>
          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; justify-content:flex-start; width:100%;" id="alg-blocks"></div>
          <div id="alg-plan-card" class="card" style="margin-top:10px;">
            <h3>Seu plano</h3>
            <div id="alg-plan" class="muted">(vazio)</div>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <button id="alg-executar" class="button">Executar</button>
              <button id="alg-refazer" class="button secondary">Refazer</button>
              <a id="alg-prosseguir" class="button" href="#/generalizacao" style="display:none;">Próximo: Generalize+</a>
            </div>
            <div id="alg-feedback" class="muted" style="margin-top:8px;"></div>
          </div>
          <div class="tip" style="margin-top:12px;">
            <div>
              <div id="alg-tip"></div>
            </div>
          </div>
          <div style="margin-top:14px;">
            <label for="alg-reflexao">Reflexão (MAPEAR):</label>
            <textarea id="alg-reflexao" class="input" rows="3" placeholder="Sua sequência funcionaria para qualquer pessoa? Prevê alternativas?"></textarea>
            <button id="alg-salvar" class="button secondary" disabled style="margin-top:8px;">Salvar reflexão</button>
          </div>
        </section>
      `;
      TipEngine.mountTip('#alg-tip', { pillar: 'algoritmo', level: 'Hint' });
      const phaseEl = document.getElementById('alg-phase');
      const blocksEl = document.getElementById('alg-blocks');
      const planEl = document.getElementById('alg-plan');
      const fb = document.getElementById('alg-feedback');
      const btnRun = document.getElementById('alg-executar');
      const btnReset = document.getElementById('alg-refazer');
      const btnNext = document.getElementById('alg-prosseguir');
      const reflexEl = document.getElementById('alg-reflexao');
      const saveBtn = document.getElementById('alg-salvar');
      const imgEl = document.getElementById('alg-image');
      const jumpEl = document.getElementById('alg-jump');
      const instrEl = document.getElementById('alg-instrucao');
      const planCardEl = document.getElementById('alg-plan-card');

      if (jumpEl) {
        for (let i = 1; i <= phases.length; i++) {
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = String(i);
          if (i === step) opt.selected = true;
          jumpEl.appendChild(opt);
        }
        jumpEl.addEventListener('change', () => {
          const next = parseInt(jumpEl.value, 10);
          if (!Number.isNaN(next)) {
            step = Math.max(1, Math.min(phases.length, next));
            if (history && history.replaceState) {
              history.replaceState(null, '', `#/algoritmo?fase=${step}`);
            }
            renderPhase();
          }
        });
      }

      function renderPlan() {
        planEl.textContent = plan.length ? plan.join(' → ') : '(vazio)';
      }

      function renderBlocks() {
        blocksEl.innerHTML = '';
        blocks.forEach(b => {
          const btn = document.createElement('button');
          btn.className = 'button';
          btn.textContent = `[${b}]`;
          btn.addEventListener('click', () => {
            plan.push(b);
            renderPlan();
          });
          blocksEl.appendChild(btn);
        });
      }

      function renderPhase() {
        phaseEl.textContent = `Fase ${step} de ${phases.length}`;
        if (jumpEl) jumpEl.value = String(step);
        plan = [];
        scenarioChoice = null;
        renderPlan();
        fb.textContent = '';
        const current = phases[step - 1];
        const isScenario = Array.isArray(current.opcoes) && current.resposta;
        if (instrEl) {
          if (isScenario) {
            instrEl.innerHTML = `${current.pergunta || ''}<br><span class="muted">${current.situacao || ''}</span>`;
          } else {
            instrEl.textContent = 'Monte um algoritmo para atravessar um labirinto simples.';
          }
        }
        if (imgEl) {
          const algImages = [
            './labirinto.png',
            './labirinto2.png',
            './labirinto3.png',
            './labirinto4.png',
            './labirinto5.png',
            './labirinto6.png',
            './labirinto7.png',
            './labirinto8.png',
            './labirinto9.png',
            './labirinto10.png',
            './labirinto11.png',
            './labirinto12.png',
            './labirinto13.png',
            './labirinto14.png'
          ];
          if (isScenario) {
            imgEl.style.display = 'none';
          } else {
            imgEl.style.display = 'block';
            imgEl.src = algImages[step - 1] || algImages[0];
          }
        }
        if (planCardEl) planCardEl.style.display = 'block';
        if (btnRun) btnRun.textContent = isScenario ? 'Verificar' : 'Executar';
        if (btnReset) btnReset.style.display = isScenario ? 'none' : 'inline-flex';
        if (planEl) planEl.textContent = isScenario ? '(selecione uma opção acima)' : (plan.length ? plan.join(' → ') : '(vazio)');
        blocksEl.innerHTML = '';
        if (isScenario) {
          (current.opcoes || []).forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'button';
            btn.textContent = String(opt);
            btn.addEventListener('click', () => {
              scenarioChoice = opt;
              Array.from(blocksEl.children).forEach(ch => ch.className = 'button');
              btn.className = 'button active';
            });
            blocksEl.appendChild(btn);
          });
        } else {
          renderBlocks();
        }
      }

      btnRun.addEventListener('click', () => {
        attempts += 1;
        Storage.attempt('algoritmo');
        const current = phases[step - 1];
        const isScenario = Array.isArray(current.opcoes) && current.resposta;
        let ok = false;
        if (isScenario) {
          if (!scenarioChoice) {
            fb.innerHTML = '<span style="color: var(--warning);">Selecione uma opção.</span>';
            return;
          }
          ok = scenarioChoice === current.resposta;
        } else {
          const expected = current.expected;
          ok = plan.length === expected.length && plan.every((v, i) => v === expected[i]);
        }
        if (ok) {
          corrects += 1;
          if (step < phases.length) {
            Storage.record('minigame_step', { key: 'algoritmo', step, correct: true });
            const note = isScenario ? (current.dica || 'Sequência correta para a situação.') : current.note;
            fb.innerHTML = `<span style="color: var(--ok);">Plano executado! ${note} Próxima fase...</span>`;
            step += 1;
            setTimeout(renderPhase, 2000);
          } else {
            const mistakes = attempts - corrects;
            const raw = Math.round(10 * phases.length / Math.max(attempts, 1));
            const score = Math.max(0, Math.min(10, raw));
            Storage.score('algoritmo', score);
            Storage.complete('algoritmo');
            Storage.achieve('Planejou sequências claras em múltiplas fases');
            Storage.record('minigame_result', { key: 'algoritmo', attempts, mistakes, correct: true });
            fb.innerHTML = '<span style="color: var(--ok);">Sucesso! Você completou todas as fases.</span>';
            btnNext.style.display = 'inline-flex';
            saveBtn.disabled = false;
          }
        } else {
          if (isScenario) {
            Storage.record('minigame_try', { key: 'algoritmo', step, choice: scenarioChoice });
            fb.innerHTML = '<span style="color: var(--warning);">Reveja a situação e a ordem correta de ações.</span>';
          } else {
            Storage.record('minigame_try', { key: 'algoritmo', step, plan: [...plan] });
            fb.innerHTML = '<span style="color: var(--warning);">Teste passo a passo: onde seu plano falha?</span>';
          }
          TipEngine.mountTip('#alg-tip', { pillar: 'algoritmo', level: 'Scaffold' });
        }
      });

      btnReset.addEventListener('click', () => {
        plan = [];
        renderPlan();
        fb.textContent = '';
      });

      saveBtn.addEventListener('click', () => {
        Storage.reflect('algoritmo', reflexEl.value.trim());
        fb.innerHTML = 'Reflexão salva.';
      });

      renderPhase();
    }

    function renderGeneralizacao() {
      let step = 1;
      let attempts = 0;
      let corrects = 0;
      const phases = [
        { set: [2, 5, 8, 11, 14], rule: 'Colete apenas números pares.', correct: (sel) => sel.sort().join(',') === [2, 8, 14].sort().join(',') },
        { set: ['Ás', '2', '3', '5', '8', '9'], rule: 'Mesma regra, agora em cartas (Ás=1).', correct: (sel) => sel.sort().join(',') === ['2', '8'].sort().join(',') },
        { set: ['R$ 10', 'R$ 13', 'R$ 16', 'R$ 21', 'R$ 34', 'R$ 20'], rule: 'Apenas múltiplos de 4.', correct: (sel) => sel.sort().join(',') === ['R$ 16', 'R$ 20'].sort().join(',') },
        { set: ['Par=✅', 'Ímpar=❌', '2', '3', '4', '5', '8'], rule: 'Siga a regra: selecione somente pares.', correct: (sel) => sel.sort().join(',') === ['2', '4', '8'].sort().join(',') },
        { set: ['12 kg', '7 kg', '4 kg', '9 kg', '13 kg'], rule: 'Selecione apenas pesos ímpares.', correct: (sel) => sel.sort().join(',') === ['7 kg', '9 kg', '13 kg'].sort().join(',') },
        { set: ['fileA_v2', 'fileB_v3', 'fileC_v4', 'fileC_v7', 'fileC_v9'], rule: 'Selecione somente versões pares.', correct: (sel) => sel.sort().join(',') === ['fileA_v2', 'fileC_v4'].sort().join(',') },
        { set: ['2h', '3h', '6h', '7h', '9h', '13h'], rule: 'Selecione durações múltiplas de 3.', correct: (sel) => sel.sort().join(',') === ['3h', '6h', '9h'].sort().join(',') },
        { set: [20, 21, 22, 23, 24, 26, 31, 34], rule: 'Selecione apenas números pares.', correct: (sel) => sel.sort().join(',') === [20, 22, 24, 26, 34].sort().join(',') },
        { set: ['Sala 101', 'Sala 102', 'Sala 203', 'Sala 204', 'Sala 207'], rule: 'Apenas números ímpares.', correct: (sel) => sel.sort().join(',') === ['Sala 101', 'Sala 203', 'Sala 207'].sort().join(',') },
        { set: ['Par', '2', 'Ímpar', '3', '4', 'Seis','Oito', '11'], rule: 'Apenas valores primos.', correct: (sel) => sel.sort().join(',') === ['2', '3', '11'].sort().join(',') }
        ,
        { situacao: 'Você aprendeu a calcular a área de um quadrado.', pergunta: 'Como generalizar para um retângulo?', opcoes: ['Base × altura', 'Somar lados', 'Usar fórmula de círculo', 'Contar quadradinhos'], resposta: 'Base × altura', dica: 'Pense em regras que funcionam em mais casos.' },
        { situacao: 'Você aprendeu a fazer a soma de dois números.', pergunta: 'Como generalizar para somar três ou mais números?', opcoes: ['Somar dois números de cada vez', 'Somar apenas os dois primeiros', 'Multiplicar os números', 'Subtrair o último'], resposta: 'Somar dois números de cada vez', dica: 'Generalização permite aplicar o mesmo conceito repetidamente.' },
        { situacao: 'Você aprendeu a criar uma função que calcula o dobro de um número.', pergunta: 'Como generalizar para calcular o triplo ou qualquer múltiplo?', opcoes: ['Multiplicar o número pelo fator desejado', 'Somar 2 sempre', 'Usar apenas o dobro', 'Subtrair 1'], resposta: 'Multiplicar o número pelo fator desejado', dica: 'Generalizar significa tornar a solução aplicável a diferentes casos.' },
        { situacao: 'Você aprendeu a ordenar dois números em ordem crescente.', pergunta: 'Como generalizar para ordenar uma lista de vários números?', opcoes: ['Comparar todos os pares e organizar', 'Somar todos os números', 'Escolher aleatoriamente', 'Multiplicar todos os números'], resposta: 'Comparar todos os pares e organizar', dica: 'Generalização estende a lógica para casos maiores.' },
        { situacao: 'Você aprendeu a identificar se um número é par ou ímpar.', pergunta: 'Como generalizar para identificar múltiplos de qualquer número?', opcoes: ['Verificar resto da divisão pelo número desejado', 'Somar o número com outro', 'Multiplicar por 2', 'Subtrair 1'], resposta: 'Verificar resto da divisão pelo número desejado', dica: 'Generalização permite adaptar uma regra a diferentes valores.' },
        { situacao: 'Você aprendeu a desenhar um círculo com raio 5 cm.', pergunta: 'Como generalizar para qualquer raio?', opcoes: ['Usar a fórmula do círculo com o raio desejado', 'Sempre usar 5 cm', 'Desenhar quadrados', 'Desenhar triângulos'], resposta: 'Usar a fórmula do círculo com o raio desejado', dica: 'Transforme a solução específica em uma regra geral.' },
        { situacao: 'Você aprendeu a escrever uma frase em maiúsculas.', pergunta: 'Como generalizar para qualquer frase?', opcoes: ['Aplicar a função de maiúsculas em qualquer texto', 'Somente na primeira frase', 'Ignorar o texto', 'Escrever sempre a mesma frase'], resposta: 'Aplicar a função de maiúsculas em qualquer texto', dica: 'Generalização aplica regras a diversos casos.' },
        { situacao: 'Você aprendeu a calcular a média de duas notas.', pergunta: 'Como generalizar para calcular a média de várias notas?', opcoes: ['Somar todas as notas e dividir pelo total', 'Somar apenas duas notas', 'Multiplicar as notas', 'Subtrair a primeira nota'], resposta: 'Somar todas as notas e dividir pelo total', dica: 'Generalização transforma um método específico em um método mais amplo.' },
        { situacao: 'Você aprendeu a encontrar o maior de dois números.', pergunta: 'Como generalizar para encontrar o maior de uma lista de números?', opcoes: ['Comparar todos os números entre si', 'Escolher aleatoriamente', 'Somar todos os números', 'Multiplicar os números'], resposta: 'Comparar todos os números entre si', dica: 'Generalização amplia a aplicação de uma regra simples.' },
        { situacao: 'Você aprendeu a desenhar um triângulo equilátero de lado 3 cm.', pergunta: 'Como generalizar para qualquer tamanho de lado?', opcoes: ['Usar a mesma regra ajustando o lado desejado', 'Sempre usar 3 cm', 'Desenhar quadrados', 'Desenhar círculos'], resposta: 'Usar a mesma regra ajustando o lado desejado', dica: 'Generalização transforma uma solução específica em aplicável a qualquer caso.' },
        { situacao: 'Você aprendeu a identificar letras vogais em uma palavra.', pergunta: 'Como generalizar para identificar vogais em qualquer palavra?', opcoes: ['Verificar cada letra da palavra contra o conjunto de vogais', 'Somente na primeira palavra', 'Ignorar letras', 'Sempre marcar a primeira letra'], resposta: 'Verificar cada letra da palavra contra o conjunto de vogais', dica: 'Generalização aplica regras conhecidas a múltiplos casos.' },
        { situacao: 'Você aprendeu a somar números positivos.', pergunta: 'Como generalizar para somar qualquer número, incluindo negativos?', opcoes: ['Usar a mesma operação de soma com qualquer número', 'Somar apenas positivos', 'Ignorar negativos', 'Multiplicar números negativos'], resposta: 'Usar a mesma operação de soma com qualquer número', dica: 'Generalização amplia o escopo de aplicação de uma operação.' },
        { situacao: 'Você aprendeu a criar um quadrado com caneta.', pergunta: 'Como generalizar para criar qualquer polígono?', opcoes: ['Definir número de lados e tamanho e seguir a mesma lógica', 'Sempre fazer quadrados', 'Desenhar círculos', 'Ignorar lados'], resposta: 'Definir número de lados e tamanho e seguir a mesma lógica', dica: 'Generalização permite transformar métodos específicos em métodos gerais.' },
        { situacao: 'Você aprendeu a formatar uma célula no Excel para números inteiros.', pergunta: 'Como generalizar para formatar qualquer tipo de dado?', opcoes: ['Aplicar regras de formatação de acordo com o tipo de dado', 'Sempre usar inteiro', 'Ignorar formatação', 'Usar texto apenas'], resposta: 'Aplicar regras de formatação de acordo com o tipo de dado', dica: 'Generalização adapta regras específicas a diferentes situações.' },
        { situacao: 'Você aprendeu a calcular o perímetro de um quadrado.', pergunta: 'Como generalizar para calcular o perímetro de qualquer polígono regular?', opcoes: ['Multiplicar o número de lados pelo tamanho do lado', 'Somar lados aleatoriamente', 'Usar sempre quadrado', 'Ignorar lados'], resposta: 'Multiplicar o número de lados pelo tamanho do lado', dica: 'Generalização transforma fórmulas específicas em fórmulas aplicáveis a muitos casos.' },
        { situacao: 'Você aprendeu a identificar números primos entre 1 e 10.', pergunta: 'Como generalizar para identificar números primos em qualquer intervalo?', opcoes: ['Verificar se o número só é divisível por 1 e ele mesmo', 'Marcar números aleatórios', 'Somar todos os números', 'Multiplicar números'], resposta: 'Verificar se o número só é divisível por 1 e ele mesmo', dica: 'Generalização aplica a regra fundamental a diferentes conjuntos.' }
      ];

      // Ajuste do parâmetro de fase após conhecer o total de fases
      try {
        const params = new URLSearchParams((window.location.hash.split('?')[1] || ''));
        const faseParam = parseInt(params.get('fase') || '1', 10);
        if (!Number.isNaN(faseParam)) step = Math.max(1, Math.min(phases.length, faseParam));
      } catch {}

      appEl.innerHTML = `
        <section class="card">
          <h1>Generalize+</h1>
          <div id="gen-phase"></div>
          <div style="margin-top:8px;">
            <label for="gen-jump">Ir para fase:</label>
            <select id="gen-jump" class="input" style="max-width:120px; display:inline-block; margin-left:8px;"></select>
          </div>
          <div id="gen-options" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;"></div>
          <div style="display:flex; gap:10px; margin-top:10px;">
            <button id="gen-verificar" class="button">Verificar</button>
            <a id="gen-finalizar" class="button" href="#/robotica" style="display:none;">Próximo: Robótica</a>
          </div>
          <div id="gen-feedback" class="muted" style="margin-top:10px;"></div>
          <div class="tip" style="margin-top:12px;">
            <div>
              <div id="gen-tip"></div>
            </div>
          </div>
          <div style="margin-top:14px;">
            <label for="gen-reflexao">Reflexão (MAPEAR):</label>
            <textarea id="gen-reflexao" class="input" rows="3" placeholder="Qual lógica permanece igual ao mudar o cenário?"></textarea>
            <button id="gen-salvar" class="button secondary" disabled style="margin-top:8px;">Salvar reflexão</button>
          </div>
        </section>
      `;

      const phaseEl = document.getElementById('gen-phase');
      const optsEl = document.getElementById('gen-options');
      const fb = document.getElementById('gen-feedback');
      const btnCheck = document.getElementById('gen-verificar');
      const btnFinish = document.getElementById('gen-finalizar');
      const reflexEl = document.getElementById('gen-reflexao');
      const saveBtn = document.getElementById('gen-salvar');
      const jumpEl = document.getElementById('gen-jump');

      if (jumpEl) {
        for (let i = 1; i <= phases.length; i++) {
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = String(i);
          if (i === step) opt.selected = true;
          jumpEl.appendChild(opt);
        }
        jumpEl.addEventListener('change', () => {
          const next = parseInt(jumpEl.value, 10);
          if (!Number.isNaN(next)) {
            step = Math.max(1, Math.min(phases.length, next));
            if (history && history.replaceState) {
              history.replaceState(null, '', `#/generalizacao?fase=${step}`);
            }
            renderPhase();
          }
        });
      }

      let selection = new Set();

      function renderPhase() {
        selection = new Set();
        optsEl.innerHTML = '';
        const current = phases[step - 1];
        const isScenario = Array.isArray(current.opcoes) && current.resposta;
        if (isScenario) {
          phaseEl.innerHTML = `<div class="muted">Fase ${step} de ${phases.length}</div><p>${current.pergunta}</p><div class="muted">${current.situacao || ''}</div>`;
        } else {
          phaseEl.innerHTML = `<div class="muted">Fase ${step} de ${phases.length}</div><p>${current.rule}</p><div class="muted">Conjunto: ${current.set.join(', ')}</div>`;
        }
        if (jumpEl) jumpEl.value = String(step);
        TipEngine.mountTip('#gen-tip', { pillar: 'generalizacao', level: 'Hint' });
        const values = isScenario ? (current.opcoes || []) : (current.set || []);
        values.forEach(v => {
          const btn = document.createElement('button');
          btn.className = 'button';
          btn.textContent = String(v);
          btn.addEventListener('click', () => {
            if (isScenario) {
              selection = new Set([v]);
              Array.from(optsEl.children).forEach(ch => { ch.className = 'button'; });
              btn.className = 'button active';
            } else {
              if (selection.has(v)) selection.delete(v); else selection.add(v);
              btn.className = selection.has(v) ? 'button active' : 'button';
            }
          });
          optsEl.appendChild(btn);
        });
      }

      btnCheck.addEventListener('click', () => {
        attempts += 1;
        Storage.attempt('generalizacao');
        const current = phases[step - 1];
        const isScenario = Array.isArray(current.opcoes) && current.resposta;
        const correct = isScenario ? ([...selection][0] === current.resposta) : current.correct([...selection]);
        if (correct) {
          corrects += 1;
          if (step < phases.length) {
            Storage.record('minigame_step', { key: 'generalizacao', step, correct: true });
            const note = isScenario ? (current.dica || 'Boa! Regra aplicada em novo contexto.') : `Fase ${step} concluída.`;
            fb.innerHTML = `<span style=\"color: var(--ok);\">${note} Próxima fase...</span>`;
            step += 1;
            renderPhase();
          } else {
            const mistakes = attempts - corrects;
            const raw = Math.round(10 * phases.length / Math.max(attempts, 1));
            const score = Math.max(0, Math.min(10, raw));
            Storage.score('generalizacao', score);
            Storage.complete('generalizacao');
            Storage.achieve('Transferiu a regra para múltiplos contextos');
            Storage.record('minigame_result', { key: 'generalizacao', attempts, mistakes, correct: true });
            fb.innerHTML = '<span style="color: var(--ok);">Concluído! Você aplicou a mesma lógica em vários cenários.</span>';
            btnFinish.style.display = 'inline-flex';
            saveBtn.disabled = false;
          }
        } else {
          Storage.record('minigame_try', { key: 'generalizacao', step, selection: [...selection] });
          const warn = isScenario ? (current.dica || 'Releia a pergunta e aplique a regra aprendida.') : 'Mesma lógica: selecione apenas os valores que atendem à regra.';
          fb.innerHTML = `<span style="color: var(--warning);">${warn}</span>`;
          TipEngine.mountTip('#gen-tip', { pillar: 'generalizacao', level: 'Scaffold' });
        }
      });

      saveBtn.addEventListener('click', () => {
        Storage.reflect('generalizacao', reflexEl.value.trim());
        fb.innerHTML = 'Reflexão salva.';
      });

      renderPhase();
    }

    function renderRobotica() {
      const fases = [
        {
          situacao: 'Sensor ultrassônico detecta distância < 15 cm à frente.',
          pergunta: 'Qual ação imediata evita colisão?',
          opcoes: ['Seguir em frente', 'Virar à esquerda', 'Acender LED verde'],
          correta: 'Virar à esquerda',
          dica: 'Quando a distância é pequena, mude a direção.'
        },
        {
          situacao: 'Sensor de luz identifica faixa preta contínua sob o robô.',
          pergunta: 'Qual é a estratégia típica de um robô seguidor de linha?',
          opcoes: ['Parar', 'Seguir em frente', 'Girar 180°'],
          correta: 'Seguir em frente',
          dica: 'Na linha, avanço mantém o rastreamento.'
        },
        {
          situacao: 'Sensor de temperatura indica 31 °C no interior da carcaça.',
          pergunta: 'Que atuador ajuda a reduzir a temperatura?',
          opcoes: ['Ativar ventilador', 'Acender LED azul', 'Emitir som'],
          correta: 'Ativar ventilador',
          dica: 'Atuadores mecânicos alteram o ambiente.'
        },
        {
          situacao: 'Sensor de luminosidade registra 5% (ambiente muito escuro).',
          pergunta: 'Qual feedback comunica o estado ao usuário?',
          opcoes: ['Acender LED vermelho', 'Acender LED verde', 'Virar à direita'],
          correta: 'Acender LED vermelho',
          dica: 'Sinalização visual avisa condição crítica.'
        },
        {
          situacao: 'Sensor de som detecta alarme alto contínuo por 10s.',
          pergunta: 'Que ação sinaliza emergência ao operador?',
          opcoes: ['Parar motores e piscar LED vermelho', 'Aumentar velocidade', 'Tocar música ambiente'],
          correta: 'Parar motores e piscar LED vermelho',
          dica: 'Emergências pedem parada e alerta visual.'
        },
        {
          situacao: 'Sensor de gás registra concentração acima do limite seguro.',
          pergunta: 'Qual atuação reduz a exposição?',
          opcoes: ['Abrir válvula de exaustão', 'Acender LED azul', 'Virar à direita'],
          correta: 'Abrir válvula de exaustão',
          dica: 'Remover o gás do ambiente é prioridade.'
        },
        {
          situacao: 'Sensor infravermelho detecta obstáculo à direita; esquerda livre.',
          pergunta: 'Qual desvio é mais eficiente?',
          opcoes: ['Virar à direita', 'Virar à esquerda', 'Seguir em frente'],
          correta: 'Virar à esquerda',
          dica: 'Escolha o caminho livre baseado no sensor.'
        },
        {
          situacao: 'Sensor de umidade do solo indica seco (0–10%).',
          pergunta: 'Qual atuador resolve a necessidade imediata?',
          opcoes: ['Acionar bomba d’água', 'Acender LED verde', 'Reproduzir som'],
          correta: 'Acionar bomba d’água',
          dica: 'Atuador deve alterar o estado medido pelo sensor.'
        },
        {
          situacao: 'Sensor de corrente indica sobrecarga no motor da roda esquerda.',
          pergunta: 'Qual ação preventiva evita dano?',
          opcoes: ['Reduzir PWM do motor esquerdo', 'Aumentar velocidade do motor direito', 'Acender LED verde'],
          correta: 'Reduzir PWM do motor esquerdo',
          dica: 'Aja no atuador afetado para reduzir esforço.'
        },
        {
          situacao: 'Sensor de proximidade detecta borda de mesa (queda iminente).',
          pergunta: 'Qual ação imediata é mais segura?',
          opcoes: ['Dar ré e virar 90°', 'Seguir em frente', 'Girar 180° no lugar e seguir'],
          correta: 'Dar ré e virar 90°',
          dica: 'Afaste-se e mude direção para longe do risco.'
        },
        {
          situacao: 'Sensor detecta obstáculo a 5 cm.',
          pergunta: 'O que o robô faz?',
          opcoes: ['Para e gira', 'Continua reto', 'Liga música'],
          correta: 'Para e gira',
          dica: 'Se não pode seguir, decide outro caminho.'
        },
        {
          situacao: 'Robô com 2 sensores de linha detecta preto em ambos.',
          pergunta: 'O que significa?',
          opcoes: ['Está centralizado', 'Está fora da linha', 'Bateria fraca'],
          correta: 'Está centralizado',
          dica: 'Se ambos percebem igual, há equilíbrio.'
        },
        {
          situacao: 'Robô anda 3 passos e vira à direita. Após 4 repetições?',
          pergunta: 'Qual o resultado?',
          opcoes: ['Volta ao início', 'Fica perdido', 'Anda em círculo'],
          correta: 'Volta ao início',
          dica: 'Veja o ciclo completo.'
        },
        {
          situacao: 'Motor esquerdo mais rápido que o direito.',
          pergunta: 'O robô faz?',
          opcoes: ['Curva para a direita', 'Curva para a esquerda', 'Vai reto'],
          correta: 'Curva para a direita',
          dica: 'Mais velocidade de um lado puxa.'
        }
        ,
        {
          situacao: 'Um robô tem sensores de proximidade. Sempre que detecta objeto a menos de 10cm, ele para.',
          pergunta: 'Qual habilidade do Pensamento Computacional está sendo usada?',
          opcoes: ['Generalização', 'Padrões', 'Algoritmo', 'Abstração'],
          resposta: 'Algoritmo',
          dica: 'Programar respostas do robô é construir um algoritmo.'
        },
        {
          situacao: 'Um robô precisa seguir uma linha preta no chão.',
          pergunta: 'Qual habilidade do PC é necessária para isso?',
          opcoes: ['Algoritmo', 'Padrões', 'Generalização', 'Abstração'],
          resposta: 'Padrões',
          dica: 'Identificar cores ou formas repetitivas é reconhecer padrões.'
        },
        {
          situacao: 'Você precisa programar um robô que entregue objetos em pontos específicos.',
          pergunta: 'Qual habilidade é fundamental para definir os passos corretos?',
          opcoes: ['Algoritmo', 'Abstração', 'Padrões', 'Generalização'],
          resposta: 'Algoritmo',
          dica: 'Sequência de ações determina o comportamento do robô.'
        },
        {
          situacao: 'Um robô reconhece que todos os dias recebe instruções semelhantes.',
          pergunta: 'Qual habilidade está sendo aplicada?',
          opcoes: ['Generalização', 'Padrões', 'Algoritmo', 'Abstração'],
          resposta: 'Generalização',
          dica: 'Aprender com exemplos anteriores para aplicar em novos casos.'
        },
        {
          situacao: 'Você vai programar um robô para desviar de obstáculos aleatórios.',
          pergunta: 'Qual habilidade ajuda a focar no essencial para o robô funcionar?',
          opcoes: ['Abstração', 'Padrões', 'Algoritmo', 'Generalização'],
          resposta: 'Abstração',
          dica: 'Foque no que realmente afeta o funcionamento do robô.'
        },
        {
          situacao: 'O robô deve acender uma luz sempre que detecta movimento.',
          pergunta: 'Qual habilidade do PC você aplica?',
          opcoes: ['Algoritmo', 'Padrões', 'Generalização', 'Abstração'],
          resposta: 'Algoritmo',
          dica: 'Defina ações baseadas em entradas do sensor.'
        },
        {
          situacao: 'O robô identifica objetos vermelhos e evita-os.',
          pergunta: 'Qual habilidade do Pensamento Computacional é usada?',
          opcoes: ['Abstração', 'Padrões', 'Generalização', 'Algoritmo'],
          resposta: 'Padrões',
          dica: 'Reconhecer cores ou características repetitivas é identificar padrões.'
        },
        {
          situacao: 'Você quer que o robô repita uma ação várias vezes.',
          pergunta: 'Qual habilidade é aplicada?',
          opcoes: ['Algoritmo', 'Padrões', 'Generalização', 'Abstração'],
          resposta: 'Algoritmo',
          dica: 'Sequência de instruções pode incluir repetição (loop).'
        },
        {
          situacao: 'O robô aprende que sempre que encontra uma parede deve virar à direita.',
          pergunta: 'Qual habilidade está sendo usada?',
          opcoes: ['Padrões', 'Abstração', 'Generalização', 'Algoritmo'],
          resposta: 'Generalização',
          dica: 'O robô aplica a regra em qualquer parede encontrada.'
        },
        {
          situacao: 'O robô deve escolher a rota mais curta entre dois pontos.',
          pergunta: 'Qual habilidade do PC está em ação?',
          opcoes: ['Algoritmo', 'Abstração', 'Padrões', 'Generalização'],
          resposta: 'Algoritmo',
          dica: 'Decisões e passos claros permitem otimizar tarefas.'
        },
        {
          situacao: 'O robô precisa reconhecer sinais de trânsito coloridos.',
          pergunta: 'Qual habilidade do Pensamento Computacional está envolvida?',
          opcoes: ['Padrões', 'Abstração', 'Algoritmo', 'Generalização'],
          resposta: 'Padrões',
          dica: 'Detectar cores ou formas repetitivas é identificar padrões.'
        },
        {
          situacao: 'O robô detecta obstáculos diferentes, mas sempre mantém a mesma estratégia para contorná-los.',
          pergunta: 'Qual habilidade é aplicada?',
          opcoes: ['Generalização', 'Padrões', 'Algoritmo', 'Abstração'],
          resposta: 'Generalização',
          dica: 'Uma regra válida para múltiplos casos é uma generalização.'
        },
        {
          situacao: 'Um robô precisa pegar objetos espalhados pelo chão e colocá-los em uma caixa.',
          pergunta: 'Qual habilidade do Pensamento Computacional ajuda a organizar os passos?',
          opcoes: ['Algoritmo', 'Padrões', 'Generalização', 'Abstração'],
          resposta: 'Algoritmo',
          dica: 'Defina a sequência de ações para completar a tarefa.'
        },
        {
          situacao: 'O robô deve ignorar sons que não sejam alarmes específicos.',
          pergunta: 'Qual habilidade do PC está sendo aplicada?',
          opcoes: ['Abstração', 'Padrões', 'Algoritmo', 'Generalização'],
          resposta: 'Abstração',
          dica: 'Foque nos sinais relevantes, ignore o resto.'
        },
        {
          situacao: 'O robô aprende a diferenciar entre caixas grandes e pequenas e aplica a mesma regra de empilhar.',
          pergunta: 'Qual habilidade está sendo usada?',
          opcoes: ['Generalização', 'Padrões', 'Algoritmo', 'Abstração'],
          resposta: 'Generalização',
          dica: 'A regra se aplica a diferentes tamanhos e casos.'
        }
      ];
      let etapa = 0;
      try {
        const params = new URLSearchParams((window.location.hash.split('?')[1] || ''));
        const faseParam = parseInt(params.get('fase') || '1', 10);
        if (!Number.isNaN(faseParam)) etapa = Math.max(0, Math.min(fases.length - 1, faseParam - 1));
      } catch {}
      let acertos = 0;
      let tentativas = 0;

      function carregarFase() {
        const fase = fases[etapa];
        appEl.innerHTML = `
          <section class="card">
            <h1>Robótica Educacional</h1>
            <div class="muted">Fase ${etapa+1} de ${fases.length}</div>
            <div style="margin-top:8px;">
              <label for="robotica-jump">Ir para fase:</label>
              <select id="robotica-jump" class="input" style="max-width:120px; display:inline-block; margin-left:8px;"></select>
            </div>
            <p class="muted">${fase.situacao}</p>
            <p><strong>${fase.pergunta}</strong></p>
            <div id="robotica-opcoes" style="display:flex; flex-direction:column; gap:8px;"></div>
            <div id="robotica-feedback" class="muted" style="margin-top:10px;"></div>
            <div class="tip" style="margin-top:12px;"><div id="robotica-tip"></div></div>
            <div style="margin-top:14px;">
              <label for="robotica-reflexao">Reflexão (MAPEAR):</label>
              <textarea id="robotica-reflexao" class="input" rows="3" placeholder="Como sua decisão usa sensores e atuadores?"></textarea>
              <button id="robotica-salvar" class="button secondary" disabled>Salvar reflexão</button>
              <a id="robotica-prosseguir" class="button" href="#/" style="display:none;">Ir para Início</a>
            </div>
          </section>
        `;
        const opcoesEl = document.getElementById("robotica-opcoes");
        const fb = document.getElementById("robotica-feedback");
        const jumpEl = document.getElementById('robotica-jump');
        if (jumpEl) {
          jumpEl.innerHTML = '';
          for (let i = 1; i <= fases.length; i++) {
            const opt = document.createElement('option');
            opt.value = String(i);
            opt.textContent = String(i);
            if (i === (etapa + 1)) opt.selected = true;
            jumpEl.appendChild(opt);
          }
          jumpEl.addEventListener('change', () => {
            const next = parseInt(jumpEl.value, 10);
            if (!Number.isNaN(next)) {
              etapa = Math.max(0, Math.min(fases.length - 1, next - 1));
              if (history && history.replaceState) {
                history.replaceState(null, '', `#/robotica?fase=${etapa + 1}`);
              }
              carregarFase();
            }
          });
        }
        fase.opcoes.forEach(opt => {
          const btn = document.createElement("button");
          btn.className = "button";
          btn.textContent = opt;
          btn.addEventListener("click", () => {
            tentativas++;
            Storage.attempt('robotica');
            const correta = (fase && (fase.correta !== undefined && fase.correta !== null)) ? fase.correta : fase.resposta;
            if (opt === correta) {
              acertos++;
              fb.innerHTML = `<span style="color: var(--ok);">Correto! Próxima fase...</span>`;
              Storage.record('minigame_step', { key: 'robotica', step: etapa + 1, correct: true });
              etapa++;
              if (etapa < fases.length) {
                setTimeout(carregarFase, 2000);
              } else {
                const mistakes = tentativas - acertos;
                const raw = Math.round(10 * fases.length / Math.max(tentativas, 1));
                const score = Math.max(0, Math.min(10, raw));
                Storage.score('robotica', score);
                Storage.complete('robotica');
                Storage.achieve('Conectou sensores e atuadores em desafios de robótica');
                Storage.record('minigame_result', { key: 'robotica', attempts: tentativas, mistakes, correct: true });
                fb.innerHTML = '<span style="color: var(--ok);">Concluído! Você completou todas as fases.</span>';
                document.getElementById("robotica-salvar").disabled = false;
                document.getElementById("robotica-prosseguir").style.display = "inline-flex";
              }
            } else {
              fb.innerHTML = `<span style=\"color: var(--warning);\">Ainda não. Dica: ${fase.dica}</span>`;
              TipEngine.mountTip('#robotica-tip', { pillar: 'robotica', level: 'Scaffold', prompts: [ fase.dica ] });
              Storage.record('minigame_try', { key: 'robotica', step: etapa + 1, guess: opt });
            }
          });
          opcoesEl.appendChild(btn);
        });
        TipEngine.mountTip('#robotica-tip', { pillar: 'robotica', level: 'Hint', prompts: [
          "Robôs usam sensores para perceber e atuadores para agir.",
          "Pense em como humanos reagem a estímulos, o robô faz o mesmo."
        ] });

        const saveBtn = document.getElementById("robotica-salvar");
        const reflexEl = document.getElementById("robotica-reflexao");
        saveBtn.addEventListener("click", () => {
          Storage.reflect('robotica', reflexEl.value.trim());
          fb.innerHTML = 'Reflexão salva.';
        });
      }

      carregarFase();
    }

    function renderReports() {
      const state = Storage.getState();
      const toScore = (s) => (s === undefined || s === null) ? '-' : s;
      appEl.innerHTML = `
        <section class="card">
          <h1>Relatórios MAPEAR</h1>
          <p class="muted">Indicadores de estratégia, justificativa e transferência de conhecimento.</p>
          <div class="grid cols-2" style="margin-top:12px;">
            <div>
              <h2>Rubricas (0–10)</h2>
              <ul class="list">
                <li>Padrões: <strong>${toScore(state.scores.padroes)}</strong></li>
                <li>Abstração: <strong>${toScore(state.scores.abstracao)}</strong></li>
                <li>Algoritmo: <strong>${toScore(state.scores.algoritmo)}</strong></li>
                <li>Generalização: <strong>${toScore(state.scores.generalizacao)}</strong></li>
                <li>Robótica: <strong>${toScore(state.scores.robotica)}</strong></li>
              </ul>
            </div>
            <div>
              <h2>Reflexões</h2>
              <ul class="list">
                <li><strong>Padrões:</strong> ${state.reflections.padroes || '<span class="muted">—</span>'}</li>
                <li><strong>Abstração:</strong> ${state.reflections.abstracao || '<span class="muted">—</span>'}</li>
                <li><strong>Algoritmo:</strong> ${state.reflections.algoritmo || '<span class="muted">—</span>'}</li>
                <li><strong>Generalização:</strong> ${state.reflections.generalizacao || '<span class="muted">—</span>'}</li>
                <li><strong>Robótica:</strong> ${state.reflections.robotica || '<span class="muted">—</span>'}</li>
              </ul>
            </div>
          </div>
        </section>
      `;
    }

    function renderSettings() {
      appEl.innerHTML = `
        <section class="card">
          <h1>Ajustes</h1>
          <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;">
            <button class="button" id="btn-export">Exportar progresso (JSON)</button>
            <label class="button secondary" for="import-file" style="cursor:pointer;">
              Importar progresso
              <input id="import-file" type="file" accept="application/json" style="display:none" />
            </label>
            <button class="button danger" id="btn-reset">Apagar tudo</button>
          </div>
          <textarea id="export-output" class="input" rows="8" placeholder="O JSON exportado aparecerá aqui" style="margin-top:12px;"></textarea>
        </section>
      `;

      document.getElementById('btn-export').addEventListener('click', () => {
        const json = Storage.export();
        const ta = document.getElementById('export-output');
        ta.value = json;
        ta.focus();
        ta.select();
      });

      document.getElementById('import-file').addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            Storage.import(reader.result);
            alert('Progresso importado com sucesso.');
            router();
          } catch (err) {
            alert('Falha ao importar JSON.');
            console.error(err);
          }
        };
        reader.readAsText(file);
      });

      document.getElementById('btn-reset').addEventListener('click', () => {
        if (confirm('Tem certeza que deseja apagar todo o progresso?')) {
          Storage.reset();
          alert('Progresso apagado.');
          router();
        }
      });
    }

    (function init(){ router(); })();
  })();
  </script>
</body>
</html>
